---
- name: Get robots
  ansible.builtin.uri:
    url: https://{{ harbor.domain }}/api/v2.0/robots?name={{ item.name }}
    password: "{{ harbor.password }}"
    user: "{{ harbor.username }}"
    force_basic_auth: true
    body_format: json
    status_code: [200, 404]
  register: harbor_robot

- name: Create robot
  ansible.builtin.uri:
    method: POST
    url: https://{{ harbor.domain }}/api/v2.0/robots
    password: "{{ harbor.password }}"
    user: "{{ harbor.username }}"
    force_basic_auth: true
    body_format: json
    body: "{{ item | to_json }}"
    status_code: [201]
  when: harbor_robot.json is defined and harbor_robot.json | length == 0

- name: Update robot
  ansible.builtin.uri:
    method: PUT
    url: https://{{ harbor.domain }}/api/v2.0/robots/{{ harbor_robot.json[0].id }}
    password: "{{ harbor.password }}"
    user: "{{ harbor.username }}"
    force_basic_auth: true
    body_format: json
    body: "{{ harbor_robot.json | ansible.builtin.combine(item | ansible.utils.remove_keys(target=['name', 'level'])) | to_json }}"
    status_code: [200]
  when: harbor_robot.json is defined and harbor_robot.json | length > 0
