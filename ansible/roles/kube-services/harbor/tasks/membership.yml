---
- name: Get memberships
  ansible.builtin.uri:
    url: https://{{ services.harbor.domain }}/api/v2.0/projects/{{ item.projectName }}/members
    password: "{{ services.harbor.password }}"
    user: "{{ services.harbor.username }}"
    force_basic_auth: true
    body_format: json
    status_code: [200, 404]
  register: harbor_memberships

- name: Find proper membership
  ansible.builtin.set_fact:
    harbor_membership_id: "{{ harbor_memberships.json | json_query('[? entity_name==`{{ item.username }}`].{entity_id: entity_id}') }}"

- name: Create project membership
  ansible.builtin.uri:
    method: POST
    url: https://{{ services.harbor.domain }}/api/v2.0/projects/{{ item.projectName }}/members
    password: "{{ services.harbor.password }}"
    user: "{{ services.harbor.username }}"
    force_basic_auth: true
    body_format: json
    body: "{{ item.membership | to_json }}"
    status_code: [201, 409]
  when: harbor_membership_id | length == 0

- name: Update project membership
  ansible.builtin.uri:
    method: PUT
    url: https://{{ services.harbor.domain }}/api/v2.0/projects/{{ item.projectName }}/members/{{ harbor_membership_id }}
    password: "{{ services.harbor.password }}"
    user: "{{ services.harbor.username }}"
    force_basic_auth: true
    body_format: json
    body: "{{ item.membership | to_json }}"
    status_code: [200]
  when: harbor_membership_id | length > 0
