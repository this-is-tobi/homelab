---
- name: Get memberships
  ansible.builtin.uri:
    url: https://{{ harbor_domain }}/api/v2.0/projects/{{ item.project_name }}/members
    password: "{{ harbor_password }}"
    user: admin
    force_basic_auth: true
    body_format: json
    status_code: [200, 404]
  register: get_harbor_memberships

- name: Find proper membership
  ansible.builtin.set_fact:
    get_harbor_membership_id: "{{ get_harbor_memberships.json | json_query('[? entity_name==`{{ item.username }}`].{entity_id: entity_id}') }}"

- name: Set membership config
  ansible.builtin.set_fact:
    membership_config: "{{ item.membership | to_json }}"

- name: Create project membership
  ansible.builtin.uri:
    method: POST
    url: https://{{ harbor_domain }}/api/v2.0/projects/{{ item.project_name }}/members
    password: "{{ harbor_password }}"
    user: admin
    force_basic_auth: true
    body_format: json
    body: "{{ membership_config }}"
    status_code: [201, 409]
  when: get_harbor_membership_id | length == 0

- name: Update project membership
  ansible.builtin.uri:
    method: PUT
    url: https://{{ harbor_domain }}/api/v2.0/projects/{{ item.project_name }}/members/{{ get_harbor_membership_id }}
    password: "{{ harbor_password }}"
    user: admin
    force_basic_auth: true
    body_format: json
    body: "{{ membership_config }}"
    status_code: [200]
  when: get_harbor_membership_id | length > 0
