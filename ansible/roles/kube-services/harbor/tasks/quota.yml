---
- name: Get project
  ansible.builtin.uri:
    url: https://{{ services.harbor.domain }}/api/v2.0/projects/{{ item.projectName }}
    password: "{{ services.harbor.password }}"
    user: "{{ services.harbor.username }}"
    force_basic_auth: true
    body_format: json
    status_code: [200, 404]
  register: harbor_project

- name: Set project quota config
  ansible.builtin.set_fact:
    quota_config: |
      { 
        "hard": { 
          "storage": {{ item.metadata.storageLimit | human_to_bytes | int }} 
        } 
      }
  when: item.metadata.storageLimit != -1

- name: Set project quota config
  ansible.builtin.set_fact:
    quota_config: |
      { 
        "hard": { 
          "storage": {{ item.metadata.storageLimit | int }} 
        } 
      }
  when: item.metadata.storageLimit == -1

- name: Get project quota
  ansible.builtin.uri:
    method: GET
    url: https://{{ services.harbor.domain }}/api/v2.0/quotas/?reference_id={{ harbor_project.json.project_id }}
    password: "{{ services.harbor.password }}"
    user: "{{ services.harbor.username }}"
    force_basic_auth: true
    status_code: [200]
  register: harbor_project_quota
  when: harbor_project.status == 200

- name: Update project quotas
  ansible.builtin.uri:
    method: PUT
    url: https://{{ services.harbor.domain }}/api/v2.0/quotas/{{ harbor_project_quota.json[0].id }}
    password: "{{ services.harbor.password }}"
    user: "{{ services.harbor.username }}"
    force_basic_auth: true
    body_format: json
    body: "{{ quota_config }}"
    status_code: [200]
  when: harbor_project_quota.status == 200
