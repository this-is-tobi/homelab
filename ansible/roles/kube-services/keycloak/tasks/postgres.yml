- name: Create namespace
  kubernetes.core.k8s:
    kind: Namespace
    name: "{{ keycloak.namespace }}"

- name: Deploy postgres cluster
  kubernetes.core.k8s:
    state: present
    template: "{{ item }}"
  with_items:
    - postgres.yml.j2

- name: Wait pg-cluster endpoint
  kubernetes.core.k8s_info:
    kind: Endpoints
    namespace: "{{ keycloak.namespace }}"
    name: pg-cluster-keycloak-rw
  register: endpoint
  until: endpoint.resources[0].subsets[0].addresses[0] is defined
  retries: 30
  delay: 5

- name: Wait initdb job to be terminated
  kubernetes.core.k8s_info:
    kind: Job
    api_version: batch/v1
    namespace: "{{ keycloak.namespace }}"
    name: pg-cluster-keycloak-1-initdb
  register: job1
  until: job1.resources | length == 0
  retries: 30
  delay: 5
