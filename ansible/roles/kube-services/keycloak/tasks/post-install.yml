- name: Create keycloak realm
  community.general.keycloak_realm:
    auth_client_id: admin-cli
    auth_keycloak_url: https://{{ keycloak.domain }}
    auth_realm: master
    auth_username: "{{ keycloak.username }}"
    auth_password: "{{ keycloak.password }}"
    id: "{{ keycloak.realm }}"
    realm: "{{ keycloak.realm }}"
    enabled: true
    registration_allowed: false
    registration_email_as_username: false
    reset_password_allowed: false
    user_managed_access_allowed: false
    verify_email: false
    brute_force_protected: true
    display_name: Fabrique Numerique
    duplicate_emails_allowed: false
    edit_username_allowed: true
    access_token_lifespan: 3600
    state: present
    password_policy: "length(8) and lowerCase(1) and upperCase(1) and specialChars(1) and digits(1) and passwordHistory(1) and notUsername() and forceExpiredPasswordChange(365)"

- name: Create keycloak admin group
  community.general.keycloak_group:
    auth_client_id: admin-cli
    auth_keycloak_url: https://{{ keycloak.domain }}
    auth_realm: master
    auth_username: "{{ keycloak.username }}"
    auth_password: "{{ keycloak.password }}"
    realm: "{{ keycloak.realm }}"
    name: "{{ item }}"
    state: present
  loop:
    - admin

- name: Create group client scope
  community.general.keycloak_clientscope:
    auth_client_id: admin-cli
    auth_keycloak_url: https://{{ keycloak.domain }}
    auth_realm: master
    auth_username: "{{ keycloak.username }}"
    auth_password: "{{ keycloak.password }}"
    name: groups
    realm: "{{ keycloak.realm }}"
    description: Get user's groups
    protocol: openid-connect
    protocol_mappers:
      - name: groups
        protocol: openid-connect
        protocolMapper: oidc-group-membership-mapper
        config:
          full.path: false
          id.token.claim: true
          access.token.claim: true
          claim.name: groups
          userinfo.token.claim: true
