---
- name: Create keycloak client
  community.general.keycloak_client:
    auth_client_id: admin-cli
    auth_keycloak_url: https://{{ services.keycloak.domain }}
    auth_realm: master
    auth_username: "{{ services.keycloak.username }}"
    auth_password: "{{ services.keycloak.password }}"
    realm: "{{ services.keycloak.realm }}"
    client_id: "{{ services.keycloak.clientIds.minio }}"
    name: "{{ services.keycloak.clientIds.minio }}"
    always_display_in_console: true
    frontchannel_logout: true
    enabled: true
    redirect_uris:
      - https://{{ services.minio.domain }}/*
      - https://{{ services.minio.apiDomain }}/*
    web_origins:
      - https://{{ services.minio.domain }}
    standard_flow_enabled: true
    implicit_flow_enabled: false
    direct_access_grants_enabled: true
    clientAuthenticatorType: client-secret
    admin_url: "https://{{ services.keycloak.domain }}/admin"
    public_client: false
    protocol: openid-connect
    protocol_mappers:
      - name: minio-policy-mapper
        protocol: openid-connect
        protocolMapper: oidc-usermodel-client-role-mapper
        consentRequired: false
        config:
          id.token.claim: true
          access.token.claim: true
          claim.name: minio-policy
          userinfo.token.claim: true
          jsonType.label: String
          aggregate.attrs: true
          client_id: "{{ services.keycloak.clientIds.minio }}"
          multivalued: true
    default_client_scopes:
      - generic
      - groups
    attributes:
      use.jwks.url: true
      jwks.url: https://{{ services.keycloak.domain }}/realms/{{ services.keycloak.realm }}/protocol/openid-connect/certs
    state: present

- name: Create keycloak roles
  community.general.keycloak_role:
    auth_client_id: admin-cli
    auth_keycloak_url: https://{{ services.keycloak.domain }}
    auth_realm: master
    auth_username: "{{ services.keycloak.username }}"
    auth_password: "{{ services.keycloak.password }}"
    name: "{{ item }}"
    realm: "{{ services.keycloak.realm }}"
    client_id: "{{ services.keycloak.clientIds.minio }}"
    description: Role for minio
    state: present
  loop:
    - consoleAdmin
    - diagnostics
    - readonly
    - readwrite
    - writeonly

- name: Map keycloak role to admin group
  community.general.keycloak_client_rolemapping:
    auth_client_id: admin-cli
    auth_keycloak_url: https://{{ services.keycloak.domain }}
    auth_realm: master
    auth_username: "{{ services.keycloak.username }}"
    auth_password: "{{ services.keycloak.password }}"
    realm: "{{ services.keycloak.realm }}"
    client_id: "{{ services.keycloak.clientIds.minio }}"
    group_name: admin
    roles:
      - name: "{{ item }}"
    state: present
  loop:
    - consoleAdmin
    - diagnostics
    - readonly
    - readwrite
    - writeonly
