- name: Apply system-upgrade-controller manifest to the cluster
  kubernetes.core.k8s:
    state: present
    src: "{{ playbook_dir }}/../roles/kube-services/system-upgrade/templates/system-upgrade-controller.yml.j2"

- name: Wait until system-upgrade-controller is up
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: system-upgrade
  register: pod_list
  until: pod_list | json_query('resources[*].status.phase') | unique == ["Running"]

- name: Deploy upgrade plan
  kubernetes.core.k8s:
    state: present
    template: "{{ item }}"
  with_items:
    - master-plan.yml.j2
    - worker-plan.yml.j2
