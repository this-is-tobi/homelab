---
# This is an example of secret containing configuration of external database.
apiVersion: v1
data:
  DB_CONNECTION_STRING: "{{ ('postgres://' + services.mattermost.postgres.app.username + ':' + services.mattermost.postgres.app.password + 'mattermost-postgres-cluster-rw:5432/mattermost') | b64encode }}"
kind: Secret
metadata:
  name: db-credentials
  namespace: mattermost
type: Opaque

---
# This is an example of secret containing credentials for an external file storage.
apiVersion: v1
data:
  accesskey: "{{ services.mattermost.s3.accessKey | b64encode }}"
  secretkey: "{{ services.mattermost.s3.secretKey | b64encode }}"
kind: Secret
metadata:
  name: file-store-credentials
  namespace: mattermost
type: Opaque

---
apiVersion: installation.mattermost.com/v1beta1
kind: Mattermost
metadata:
  name: mattermost
  namespace: mattermost
spec:
  image: docker.io/mattermost/mattermost-team-edition
  imagePullPolicy: IfNotPresent
  version: 8.0.1
  size: 1000users
  useServiceLoadBalancer: false
  ingress:
    enabled: true
    host: {{ services.mattermost.domain }}
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
    tlsSecret: letsencrypt-prod-key
#   mattermostEnv:
#     - name: MM_FILESETTINGS_AMAZONS3SSE
#       value: "true"
#     - name: MM_FILESETTINGS_AMAZONS3SSL
#       value: "true"
  database:
    external:
      secret: db-credentials
  fileStore:
    external:
      url: {{ services.minio.apiDomain }}
      bucket: mattermost
      secret: file-store-credentials
  scheduling:
    nodeSelector:
      node-type: worker
