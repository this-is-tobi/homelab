- name: Retrieve vault keys
  kubernetes.core.k8s_info:
    namespace: "{{ vault.namespace }}"
    kind: Secret
    name: vault-admin
  register: vault_keys

- name: Set vault token
  ansible.builtin.set_fact:
    vault_token: "{{ vault_keys.resources[0].data.rootToken | b64decode }}"

- name: Retrieve argocd credentials
  kubernetes.core.k8s_info:
    namespace: "{{ argocd.namespace }}"
    kind: Secret
    name: argocd-admin
  register: argocd_secret

- name: Get argocd api token
  ansible.builtin.uri:
    url: "https://{{ argocd.domain }}/api/v1/session"
    method: POST
    body_format: json
    body:
      "username": "{{ argocd_secret.resources[0].data.username | b64decode }}"
      "password": "{{ argocd_secret.resources[0].data.password | b64decode }}"
    status_code: 200
  register: argocd_token_call

- name: Set argocd token
  ansible.builtin.set_fact:
    argocd_token: "{{ argocd_token_call.json.token }}"
