# Init
- name: Init
  ansible.builtin.include_role:
    name: services/utils/initialize
  vars:
    include_keycloak: true

# Setup
- name: Setup secrets
  ansible.builtin.include_role:
    name: services/utils/secrets
  vars:
    argocd_app: vault
    vault_values:
      domain: "vault.{{ rootDomain }}"
      admin:
        username: "admin"
        password: "{{ lookup('ansible.builtin.password', '/dev/null', length=24, chars=['ascii_letters', 'digits']) }}"
      keycloak:
        clientId: "vault"

- name: Setup vars
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../argocd/apps/vault/argocd/application.yaml"
    name: vault_app_config

- name: Set fact for vault secrets
  ansible.builtin.set_fact:
    vault_namespace: "{{ vault_app_config.spec.destination.namespace }}"

# Setup sso
- name: Setup SSO
  include_tasks: sso.yml

# Install
- name: Sync application
  ansible.builtin.include_role:
    name: services/utils/synchronize
  vars:
    argocd_app: vault

# Post install
- name: Post install
  include_tasks: post-install.yml
