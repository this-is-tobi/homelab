- name: Install required system packages
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
    update_cache: true
  loop:
    - etcd-server
    - etcd-client

# - name: Create simple self-signed certificate
#   community.crypto.x509_certificate:
#     path: /etc/etcd/certs/k3s-etcd.ca
#     privatekey_path: /etc/etcd/certs/k3s-etcd.key
#     provider: selfsigned

- name: Create etcd directory
  ansible.builtin.file:
    path: /etc/etcd
    state: directory
    owner: root
    group: root

- name: Copy etcd config file
  ansible.builtin.template:
    src: "etcd.cfg.yaml.j2"
    dest: "/etc/etcd/etcd.cfg.yaml"

- name: Specify etcd config file in etcd systemd vars
  ansible.builtin.lineinfile:
    path: /etc/default/etcd
    regexp: '^ETCD_CONFIG_FILE='
    line: ETCD_CONFIG_FILE=/etc/etcd/etcd.cfg.yaml

- name: Enable and check etcd service
  ansible.builtin.service:
    name: etcd
    state: started
    enabled: yes
    # args: "--config-file /etc/etcd/etcd.cfg.yaml"

- name: Restart etcd
  ansible.builtin.service:
    name: etcd
    state: restarted
