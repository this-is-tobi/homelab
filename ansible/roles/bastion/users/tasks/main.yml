- name: Remove /etc/ssh/sshd_config.d/rename_user.conf
  ansible.builtin.file:
    state: absent
    path: /etc/ssh/sshd_config.d/rename_user.conf

- name: Create personnal group for each admin user
  ansible.builtin.group:
    name: "{{ item.username }}"
    state: present
  no_log: true
  loop: "{{ bastionUsers }}"

- name: Create admin group
  ansible.builtin.group:
    name: admin
    state: present
    gid: 2000

- name: Allow 'admin' group to have passwordless sudo
  community.general.sudoers:
    name: admin-group
    group: "admin"
    commands: ALL
    state: present

- name: Create admin users
  ansible.builtin.user:
    name: "{{ item.username }}"
    state: present
    create_home: true
    group: "{{ item.username }}"
    groups: "admin,docker"
    append: true
    generate_ssh_key: true
    ssh_key_bits: 4096
    ssh_key_type: rsa
    password: '*'
  no_log: true
  loop: "{{ bastionUsers }}"

- name: Manage ssh keys
  ansible.builtin.include_tasks: ssh.yml
  loop: "{{ bastionUsers }}"

- block:
  - name: Add openvpn users
    ansible.builtin.include_tasks: openvpn.yml
    loop: "{{ bastionUsers }}"
  delegate_to: pi.gateway
