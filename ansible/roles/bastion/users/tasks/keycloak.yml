---
- name: Include cluster vars
  ansible.builtin.include_vars: inventory/group_vars/cluster.yml

- name: Create keycloak group
  community.general.keycloak_group:
    auth_client_id: admin-cli
    auth_keycloak_url: https://{{ keycloak.domain }}
    auth_realm: master
    auth_username: "{{ keycloak.username }}"
    auth_password: "{{ keycloak.password }}"
    realm: "{{ keycloak.realm }}"
    name: "{{ item.username }}"
    state: present

- name: Create keycloak roles
  community.general.keycloak_role:
    auth_client_id: admin-cli
    auth_keycloak_url: https://{{ keycloak.domain }}
    auth_realm: master
    auth_username: "{{ keycloak.username }}"
    auth_password: "{{ keycloak.password }}"
    name: "{{ item }}"
    realm: "{{ keycloak.realm }}"
    client_id: "{{ keycloak.clientIds.minio }}"
    description: Role for minio
    state: present
  loop:
    - "{{ item.username }}"

- name: Map keycloak role to user group
  community.general.keycloak_client_rolemapping:
    auth_client_id: admin-cli
    auth_keycloak_url: https://{{ keycloak.domain }}
    auth_realm: master
    auth_username: "{{ keycloak.username }}"
    auth_password: "{{ keycloak.password }}"
    realm: "{{ keycloak.realm }}"
    client_id: "{{ keycloak.clientIds.minio }}"
    group_name: "{{ item.username }}"
    roles:
      - name: "{{ item.username }}"
    state: present

# - name: Create keycloak user
#   community.general.keycloak_user:
#     auth_client_id: admin-cli
#     auth_keycloak_url: https://{{ keycloak.domain }}
#     auth_realm: master
#     auth_username: "{{ keycloak.username }}"
#     auth_password: "{{ keycloak.password }}"
#     realm: "{{ keycloak.realm }}"
#     username: "{{ item.username }}"
#     firstName: "{{ item.firstname }}"
#     lastName: "{{ item.lastname }}"
#     email: "{{ item.email }}"
#     enabled: true
#     emailVerified: true
#     credentials:
#       - type: password
#         value: "{{ keycloak.defaultPassword }}"
#         temporary: true
#     groups:
#       - name: "{{ item.username }}"
#         state: present
#       - name: admin
#         state: present
#     state: present
