---
- name: Include cluster vars
  ansible.builtin.include_vars: inventory/group_vars/cluster.yml

- name: Set minio alias fact
  ansible.builtin.shell:
    cmd: |
      mc alias ls --json | jq -r 'select(.URL == "https://{{ services.minio.apiDomain }}").alias'
  register: mc_alias

- name: Create a directory if it does not exist
  ansible.builtin.file:
    path: "{{ bastion_local_dir }}/{{ item.username }}/minio"
    state: directory
    mode: 0755

- name: Create minio policy file
  ansible.builtin.template:
    src: minio-bucket-policy.json.j2
    dest: "{{ bastion_local_dir }}/{{ item.username }}/minio/policy.json"
    mode: 0644

- name: Create minio bucket
  amazon.aws.s3_bucket:
    name: "{{ item.username }}"
    endpoint_url: "https://{{ services.minio.apiDomain }}"
    aws_access_key: "{{ services.minio.username }}"
    aws_secret_key: "{{ services.minio.password }}"
    state: present

- name: Create minio policy
  ansible.builtin.shell:
    cmd: |
      mc admin policy create {{ mc_alias.stdout }} {{ item.username }} {{ bastion_local_dir }}/{{ item.username }}/minio/policy.json

- name: Create minio quota
  ansible.builtin.shell:
    cmd: |
      mc quota set {{ mc_alias.stdout }}/{{ item.username }} --size {{ item.minio_quota }}
