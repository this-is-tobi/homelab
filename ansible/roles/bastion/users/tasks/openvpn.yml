---
- name: Include gateway vars
  ansible.builtin.include_vars: inventory/group_vars/gateway.yml

- name: Check if user exists
  stat:
    path: "/services/openvpn/users/{{ item.username }}.ovpn"
  register: openvpn_profile

- name: Add openvpn profile for {{ item.username }}
  ansible.builtin.expect:
    command: "sh ./openvpn.sh -a {{ item.username }}"
    chdir: "/services/openvpn"
    responses:
      (?i)Confirm request details: "yes"
      (?i)Enter pass phrase for: "{{ openvpnRootPassphrase }}"
  # no_log: true
  when: not openvpn_profile.stat.exists

- name: Retrieve openvpn profile
  ansible.builtin.shell:
    cmd: "sh openvpn.sh -g {{ item.username }}"
    chdir: "/services/openvpn"
  no_log: true
  when: not openvpn_profile.stat.exists

- name: Update users conf with correct vpn server hostname
  ansible.builtin.lineinfile:
    path: "/services/openvpn/users/{{ item.username }}.ovpn"
    regexp: "^remote "
    line: "remote {{ openvpnServerHostname }} 1194 udp"
  no_log: true
  when: not openvpn_profile.stat.exists

- name: Update users conf permissions
  ansible.builtin.file:
    path: "/services/openvpn/users/{{ item.username }}.ovpn"
    owner: "root"
    group: "root"
    mode: 0751
  no_log: true
  when: not openvpn_profile.stat.exists

- name: Fetch users conf
  ansible.builtin.fetch:
    src: "/services/openvpn/users/{{ item.username }}.ovpn"
    dest: "{{ bastionLocalDir }}/{{ item.username }}/openvpn/{{ item.username }}.ovpn"
    flat: yes
  no_log: true
  when: not openvpn_profile.stat.exists
