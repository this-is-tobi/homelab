argo-cd:
  # -- Enable ArgoCD core deployment
  enabled: true
  # fullnameOverride: argo-cd-system-argocd
  crds:
    install: true
    keep: true
  configs:
    secret:
      argocdServerAdminPassword: "" # Add your bcrypt hashed password here
    params:
      server.insecure: true
    rbac:
      policy.csv: |
        p, role:none, *, *, */*, deny
        p, role:admin, *, *, */*, allow
        g, admin, role:admin
    policy.default: role:none
    scopes: "[groups]"
    cm:
      url: "" # Add your ArgoCD URL here
      resource.customizations: |
        networking.k8s.io/Ingress:
          health.lua: |
            hs = {}
            hs.status = "Healthy"
            return hs
  redis-ha:
    enabled: true
  redis:
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
  notifications:
    replicas: 1
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
  controller:
    replicas: 2
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
  server:
    replicas: 2
    autoscaling:
      enabled: false
      minReplicas: 2
      maxReplicas: 5
      targetCPUUtilizationPercentage: 75
      targetMemoryUtilizationPercentage: 75
    ingress:
      enabled: true
      hostname: "" # Add your ArgoCD server hostname here
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-http-prod
      tls: false
      extraTls:
      - hosts:
        - "" # Add your ArgoCD server hostname here
        secretName: "" # Add your ArgoCD server TLS secret name here
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
  applicationSet:
    enabled: true
    replicas: 2
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
  dex:
    enabled: false
  repoServer:
    replicas: 2
    autoscaling:
      enabled: false
      minReplicas: 2
      maxReplicas: 5
      targetCPUUtilizationPercentage: 75
      targetMemoryUtilizationPercentage: 75
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
    initContainers: []
    # - name: download-tools
    #   image: registry.access.redhat.com/ubi8
    #   env:
    #   - name: AVP_VERSION
    #     value: 1.18.1
    #   command: [sh, -c]
    #   args:
    #   - >-
    #     OS="$(uname | tr '[:upper:]' '[:lower:]')" && [ "$(uname -m)" = "aarch64" ] && ARCH="arm64" || ARCH="amd64" &&
    #     curl -L https://github.com/argoproj-labs/argocd-vault-plugin/releases/download/v$(AVP_VERSION)/argocd-vault-plugin_$(AVP_VERSION)_${OS}_${ARCH} -o argocd-vault-plugin &&
    #     chmod +x argocd-vault-plugin &&
    #     mv argocd-vault-plugin /custom-tools/
    #   volumeMounts:
    #   - mountPath: /custom-tools
    #     name: custom-tools
    # extraContainers:
    # - name: avp
    #   command: [/var/run/argocd/argocd-cmp-server]
    #   image: quay.io/argoproj/argocd:v3.2.0
    #   securityContext:
    #     runAsNonRoot: true
    #     runAsUser: 999
    #   envFrom:
    #   - secretRef:
    #       name: vault-plugin-secret
    #   volumeMounts:
    #   - mountPath: /var/run/argocd
    #     name: var-files
    #   - mountPath: /home/argocd/cmp-server/plugins
    #     name: plugins
    #   - mountPath: /tmp
    #     name: tmp
    #   # Register plugins into sidecar
    #   - mountPath: /home/argocd/cmp-server/config/plugin.yaml
    #     subPath: avp.yaml
    #     name: cmp-plugin
    #   # Important: Mount tools into $PATH
    #   - name: custom-tools
    #     subPath: argocd-vault-plugin
    #     mountPath: /usr/local/bin/argocd-vault-plugin
    # - name: avp-helm
    #   command: [/var/run/argocd/argocd-cmp-server]
    #   image: quay.io/argoproj/argocd:v3.2.0
    #   securityContext:
    #     runAsNonRoot: true
    #     runAsUser: 999
    #   envFrom:
    #   - secretRef:
    #       name: vault-plugin-secret
    #   volumeMounts:
    #   - mountPath: /var/run/argocd
    #     name: var-files
    #   - mountPath: /home/argocd/cmp-server/plugins
    #     name: plugins
    #   - mountPath: /tmp
    #     name: tmp
    #   # Register plugins into sidecar
    #   - mountPath: /home/argocd/cmp-server/config/plugin.yaml
    #     subPath: avp-helm.yaml
    #     name: cmp-plugin
    #   # Important: Mount tools into $PATH
    #   - name: custom-tools
    #     subPath: argocd-vault-plugin
    #     mountPath: /usr/local/bin/argocd-vault-plugin
    # - name: avp-kustomize
    #   command: [/var/run/argocd/argocd-cmp-server]
    #   image: quay.io/argoproj/argocd:v3.2.0
    #   securityContext:
    #     runAsNonRoot: true
    #     runAsUser: 999
    #   envFrom:
    #   - secretRef:
    #       name: vault-plugin-secret
    #   volumeMounts:
    #   - mountPath: /var/run/argocd
    #     name: var-files
    #   - mountPath: /home/argocd/cmp-server/plugins
    #     name: plugins
    #   - mountPath: /tmp
    #     name: tmp
    #   # Register plugins into sidecar
    #   - mountPath: /home/argocd/cmp-server/config/plugin.yaml
    #     subPath: avp-kustomize.yaml
    #     name: cmp-plugin
    #   # Important: Mount tools into $PATH
    #   - name: custom-tools
    #     subPath: argocd-vault-plugin
    #     mountPath: /usr/local/bin/argocd-vault-plugin
    # volumes:
    # - configMap:
    #     name: cmp-plugin
    #   name: cmp-plugin
    # - name: custom-tools
    #   emptyDir: {}

avp:
  # -- Enable ArgoCD Vault Plugin (AVP) integration.
  enabled: false
  # -- Vault server address.
  vaultAddr: "" # Add your Vault address here
  # -- Vault token.
  vaultToken: "" # Add your Vault token here
  # -- ArgoCD Vault Plugin type.
  type: "vault"
  # -- Authentication type.
  authType: "token"

argo-cd-apps:
  # -- Enable ArgoCD core deployment
  enabled: true
  projects:
    admin:
      # namespace: argocd-system
      description: Ohmlab admin project
      additionalLabels: {}
      additionalAnnotations: {}
      permitOnlyProjectScopedClusters: false
      sourceRepos:
      - '*'
      destinations:
      - namespace: '*'
        server: https://kubernetes.default.svc
      clusterResourceWhitelist:
      - group: '*'
        kind: '*'
      clusterResourceBlacklist: []
      namespaceResourceWhitelist:
      - group: '*'
        kind: '*'
      namespaceResourceBlacklist: []
      orphanedResources: {}
      roles:
      - name: admin
        description: Admin keycloak group
        groups:
        - admin
        policies:
        - p, proj:admin:admin, applications, *, infra/*, allow
      finalizers:
      - resources-finalizer.argocd.argoproj.io
      syncWindows: []
      signatureKeys: []
      sourceNamespaces: []
  applications:
    manager:
      # namespace: argocd-system
      additionalLabels: {}
      additionalAnnotations: {}
      project: admin
      sources:
      - repoURL: https://github.com/this-is-tobi/homelab.git
        path: ./argo-cd
        directory:
          include: manager.yaml
        targetRevision: main
      destination:
        server: https://kubernetes.default.svc
        namespace: argocd-system
      syncPolicy:
        preserveResourcesOnDeletion: true
        # automated:
        #   prune: false
        #   selfHeal: false
        syncOptions:
        - CreateNamespace=true
        - ApplyOutOfSyncOnly=true
      revisionHistoryLimit: 3
      ignoreDifferences: []
      info:
      - name: url
        value: https://this-is-tobi.com/homelab
      finalizers:
      - resources-finalizer.argocd.argoproj.io

instanceAppset:
  # -- Enable instance ApplicationSet deployment.
  enabled: false
  # -- Instance name used for identification.
  name: ""
  # -- Instance environment used for identification.
  env: ""
  # -- Instance provider used for identification.
  provider: ""
  # -- Instance region used for identification.
  region: ""
  prefix:
    # -- Prefix name added to all apps.
    name: ""
    # -- Prefix namespace added to all namespaces.
    namespace: ""
  suffix:
    # -- Suffix name added to all apps.
    name: ""
    # -- Suffix namespace added to all namespaces.
    namespace: ""
  destination:
    # -- Destination server URL for the instance.
    server: "https://kubernetes.default.svc"
  repoURL:
    # -- Repo URL to use as sources for the instance.
    sources: "https://github.com/this-is-tobi/homelab.git"
    # -- Repo URL to use as values for the instance.
    values: "https://github.com/this-is-tobi/homelab.git"
  # -- Target revision (branch, tag, commit) for the instance.
  targetRevision: "main"
  # -- Instance category used for identification.
  category: "core"
  # -- ArgoCD namespace where the instance apps will be deployed.
  argocdNamespace: "argocd-system"
  # -- Project the instance apps will belong to.
  project: "admin"
  # -- List of apps to deploy for the instance.
  apps: []

initSecrets:
  # -- Enable Vault init secrets job.
  enabled: true
  # -- Vault role used for authentication.
  vaultRole: "vault-init-secrets"
  # -- Whether to skip TLS verification when connecting to Vault.
  skipTLSVerify: true
  # -- Backoff limit for the init job.
  backoffLimit: 3
  # -- TTL in seconds after which the job will be cleaned up.
  ttlSecondsAfterFinished: 86400
  # -- Init job container image.
  image: "ghcr.io/this-is-tobi/tools/homelab-utils:latest"
  resources:
    requests:
      # -- CPU requests for the init job container.
      cpu: "50m"
      # -- Memory requests for the init job container.
      memory: "64Mi"
    limits:
      # -- CPU limits for the init job container.
      cpu: "200m"
      # -- Memory limits for the init job container.
      memory: "128Mi"
  # -- List of secrets to initialize in Vault.
  # Secrets to initialize using template syntax:
  # - <random:N> generates random alphanumeric string of length N
  # - <uuid> generates UUID v4
  # - <age:secret> generates age secret key
  # - <age:public> generates age public key (pair with secret key)
  # - Static values remain as-is
  # Supports nested JSON structure for organizing related secrets
  secrets:
  - path: "homelab/platforms/production/cert-manager"
    data:
      email: "this-is-tobi@proton.me"
      scaleway:
        accessKey: ""
        secretKey: ""
        projectId: ""
        domain: "ohmlab.fr"
  - path: "homelab/platforms/production/argo-cd"
    data:
      admin:
        username: "admin"
        password: "<random:24>"
      keycloak:
        endpoint: "https://sso.ohmlab.fr"
        realm: "homelab"
        clientId: "argo-cd"
        clientSecret: "<random:32>"
  - path: "homelab/platforms/production/gitea"
    data:
      admin:
        username: "admin"
        password: "<random:24>"
      postgres:
        admin:
          username: "postgres"
          password: "<random:24>"
        app:
          username: "gitea"
          password: "<random:24>"
        database: "gitea"
        host: "gitea-pg-cluster-rw"
        port: "5432"
        s3:
          accessKey: ""
          bucketName: "ohmlab-backups"
          bucketPrefix: "cnpg"
          endpoint: "https://s3.fr-par.scw.cloud"
          region: "fr-par"
          secretKey: ""
      keycloak:
        endpoint: "https://sso.ohmlab.fr"
        realm: "homelab"
        clientId: "gitea"
        clientSecret: "<random:32>"
  - path: "homelab/platforms/production/mattermost"
    data:
      admin:
        username: "admin"
        password: "<random:24>"
      postgres:
        admin:
          username: "postgres"
          password: "<random:24>"
        app:
          username: "mattermost"
          password: "<random:24>"
        database: "mattermost"
        host: "mattermost-pg-cluster-rw"
        port: "5432"
        s3:
          accessKey: ""
          bucketName: "ohmlab-backups"
          bucketPrefix: "cnpg"
          endpoint: "https://s3.fr-par.scw.cloud"
          region: "fr-par"
          secretKey: ""
      s3:
        accessKey: ""
        bucketName: "ohmlab-backups"
        bucketPrefix: "cnpg"
        endpoint: "https://s3.fr-par.scw.cloud"
        region: "fr-par"
        secretKey: ""
      keycloak:
        endpoint: "https://sso.ohmlab.fr"
        realm: "homelab"
        clientId: "mattermost"
        clientSecret: "<random:32>"
  - path: "homelab/platforms/production/minio"
    data:
      admin:
        username: "admin"
        password: "<random:24>"
  - path: "homelab/platforms/production/rustfs"
    data:
      admin:
        accessKey: "<random:16>"
        secretKey: "<random:32>"
  - path: "homelab/platforms/production/prometheus-stack"
    data:
      admin:
        username: "admin"
        password: "<random:24>"
      keycloak:
        endpoint: "https://sso.ohmlab.fr"
        realm: "homelab"
        clientId: "grafana"
        clientSecret: "<random:32>"
  - path: "homelab/platforms/production/keycloak"
    data:
      admin:
        username: "admin"
        password: "<random:24>"
      extras:
        realm: "homelab"
        rootDomain: "ohmlab.fr"
      postgres:
        admin:
          username: "postgres"
          password: "<random:24>"
        app:
          username: "keycloak"
          password: "<random:24>"
        database: "keycloak"
        host: "keycloak-pg-cluster-rw"
        port: "5432"
        s3:
          accessKey: ""
          bucketName: "ohmlab-backups"
          bucketPrefix: "cnpg"
          endpoint: "https://s3.fr-par.scw.cloud"
          region: "fr-par"
          secretKey: ""
  - path: "homelab/platforms/production/sops-test"
    data:
      extras:
        secret: "<age:secret>"
        public: "<age:public>"
  # - path: "homelab/platforms/production/argo-workflows"
  #   data:
  #     keycloak:
  #       endpoint: "https://sso.ohmlab.fr"
  #       realm: "homelab"
  #       clientId: "argo-workflows"
  #       clientSecret: "<random:32>"
  # - path: "homelab/platforms/production/coder"
  #   data:
  #     admin:
  #       username: "admin"
  #       password: "<random:24>"
  #     postgres:
  #       admin:
  #         username: "postgres"
  #         password: "<random:24>"
  #       app:
  #         username: "coder"
  #         password: "<random:24>"
  #       database: "coder"
  #       host: "coder-pg-cluster-rw"
  #       port: "5432"
  #       s3:
  #         accessKey: ""
  #         bucketName: "ohmlab-backups"
  #         bucketPrefix: "cnpg"
  #         endpoint: "https://s3.fr-par.scw.cloud"
  #         region: "fr-par"
  #         secretKey: ""
  #     keycloak:
  #       endpoint: "https://sso.ohmlab.fr"
  #       realm: "homelab"
  #       clientId: "coder"
  #       clientSecret: "<random:32>"
  # - path: "homelab/platforms/production/harbor"
  #   data:
  #     admin:
  #       username: "admin"
  #       password: "<random:24>"
  #     postgres:
  #       admin:
  #         username: "postgres"
  #         password: "<random:24>"
  #       app:
  #         username: "harbor"
  #         password: "<random:24>"
  #       database: "harbor"
  #       host: "harbor-pg-cluster-rw"
  #       port: "5432"
  #       s3:
  #         accessKey: ""
  #         bucketName: "ohmlab-backups"
  #         bucketPrefix: "cnpg"
  #         endpoint: "https://s3.fr-par.scw.cloud"
  #         region: "fr-par"
  #         secretKey: ""
  #     s3:
  #       accessKey: ""
  #       bucketName: "ohmlab-backups"
  #       bucketPrefix: "cnpg"
  #       endpoint: "https://s3.fr-par.scw.cloud"
  #       region: "fr-par"
  #       secretKey: ""
  #     keycloak:
  #       endpoint: "https://sso.ohmlab.fr"
  #       realm: "homelab"
  #       clientId: "harbor"
  #       clientSecret: "<random:32>"
  # - path: "homelab/platforms/production/mlflow"
  #   data:
  #     admin:
  #       username: "admin"
  #       password: "<random:24>"
  #     postgres:
  #       admin:
  #         username: "postgres"
  #         password: "<random:24>"
  #       app:
  #         username: "mlflow"
  #         password: "<random:24>"
  #       database: "mlflow"
  #       host: "mlflow-pg-cluster-rw"
  #       port: "5432"
  #       s3:
  #         accessKey: ""
  #         bucketName: "ohmlab-backups"
  #         bucketPrefix: "cnpg"
  #         endpoint: "https://s3.fr-par.scw.cloud"
  #         region: "fr-par"
  #         secretKey: ""
  #     s3:
  #       accessKey: ""
  #       bucketName: "ohmlab-backups"
  #       bucketPrefix: "cnpg"
  #       endpoint: "https://s3.fr-par.scw.cloud"
  #       region: "fr-par"
  #       secretKey: ""
  #     keycloak:
  #       endpoint: "https://sso.ohmlab.fr"
  #       realm: "homelab"
  #       clientId: "mlflow"
  #       clientSecret: "<random:32>"
  # - path: "homelab/platforms/production/outline"
  #   data:
  #     admin:
  #       username: "admin"
  #       password: "<random:24>"
  #     postgres:
  #       admin:
  #         username: "postgres"
  #         password: "<random:24>"
  #       app:
  #         username: "outline"
  #         password: "<random:24>"
  #       database: "outline"
  #       host: "outline-pg-cluster-rw"
  #       port: "5432"
  #       s3:
  #         accessKey: ""
  #         bucketName: "ohmlab-backups"
  #         bucketPrefix: "cnpg"
  #         endpoint: "https://s3.fr-par.scw.cloud"
  #         region: "fr-par"
  #         secretKey: ""
  #     s3:
  #       accessKey: ""
  #       bucketName: "ohmlab-backups"
  #       bucketPrefix: "cnpg"
  #       endpoint: "https://s3.fr-par.scw.cloud"
  #       region: "fr-par"
  #       secretKey: ""
  #     keycloak:
  #       endpoint: "https://sso.ohmlab.fr"
  #       realm: "homelab"
  #       clientId: "outline"
  #       clientSecret: "<random:32>"
  # - path: "homelab/platforms/production/sonarqube"
  #   data:
  #     admin:
  #       username: "admin"
  #       password: "<random:24>"
  #     postgres:
  #       admin:
  #         username: "postgres"
  #         password: "<random:24>"
  #       app:
  #         username: "sonarqube"
  #         password: "<random:24>"
  #       database: "sonarqube"
  #       host: "sonarqube-pg-cluster-rw"
  #       port: "5432"
  #       s3:
  #         accessKey: ""
  #         bucketName: "ohmlab-backups"
  #         bucketPrefix: "cnpg"
  #         endpoint: "https://s3.fr-par.scw.cloud"
  #         region: "fr-par"
  #         secretKey: ""
  #     keycloak:
  #       endpoint: "https://sso.ohmlab.fr"
  #       realm: "homelab"
  #       clientId: "sonarqube"
  #       clientSecret: "<random:32>"
  # - path: "homelab/platforms/production/vault"
  #   data:
  #     admin:
  #       token: ""
  #     keycloak:
  #       endpoint: "https://sso.ohmlab.fr"
  #       realm: "homelab"
  #       clientId: "vault"
  #       clientSecret: "<random:32>"
  # - path: "homelab/platforms/production/vault-operator"
  #   data:
  #     admin:
  #       token: ""
  #     keycloak:
  #       endpoint: "https://sso.ohmlab.fr"
  #       realm: "homelab"
  #       clientId: "vault-operator"
  #       clientSecret: "<random:32>"
  # - path: "homelab/platforms/production/vaultwarden"
  #   data:
  #     admin:
  #       token: "<random:24>"
  #     postgres:
  #       admin:
  #         username: "postgres"
  #         password: "<random:24>"
  #       app:
  #         username: "vaultwarden"
  #         password: "<random:24>"
  #       database: "vaultwarden"
  #       host: "vaultwarden-pg-cluster-rw"
  #       port: "5432"
  #       s3:
  #         accessKey: ""
  #         bucketName: "ohmlab-backups"
  #         bucketPrefix: "cnpg"
  #         endpoint: "https://s3.fr-par.scw.cloud"
  #         region: "fr-par"
  #         secretKey: ""
  #     keycloak:
  #       endpoint: "https://sso.ohmlab.fr"
  #       realm: "homelab"
  #       clientId: "vaultwarden"
  #       clientSecret: "<random:32>"
