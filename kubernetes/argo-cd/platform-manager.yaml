apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: platform-manager
  namespace: argocd-system
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
  - matrix:
      generators:
      - list:
          elements:
          - app: actions-runner-controller
          # - app: argo-cd
          # - app: argo-worklows
          - app: cloudnative-pg
          # - app: coder
          - app: dashy
          # - app: gitea
          - app: harbor
          - app: keycloak
          # - app: kubernetes-dashboard
          # - app: loki
          # - app: mattermost
          - app: minio
          # - app: outline
          - app: prometheus-stack
          # - app: sonarqube
          - app: sops
          # - app: system-upgrade
          # - app: trivy-operator
          # - app: vault
          # - app: vaultwarden
      - git:
          repoURL: https://github.com/this-is-tobi/homelab.git
          revision: main
          files:
          - path: 'kubernetes/argo-cd/envs/*/config.json'
  template:
    metadata:
      name: '{{.app}}-{{.env}}'
    spec:
      project: '{{.project}}'
      revisionHistoryLimit: 3
      source:
        repoURL: https://github.com/this-is-tobi/homelab.git
        path: 'kubernetes/argo-cd/apps/{{.app}}'
        targetRevision: main
        # plugin:
        #   # name: argocd-vault-plugin-helm
        #   releaseName: '{{.app}}-{{.env}}'
        #   # env:
        #   # - name: AVP_SECRET
        #   #   value: vault-plugin-secret
        #   # - name: HELM_ARGS
        #   #   value: -f values.yaml
        #   # - name: HELM_VALUES
        #   #   value: |
        #   #     ingress: {}
        #   #     ...
        helm:
          releaseName: '{{.app}}-{{.env}}'
          parameters: []
          valueFiles:
            - 'values.yaml'
      destination:
        server: '{{.destination.server}}'
        namespace: '{{.app}}-{{.env}}'
      syncPolicy:
        # automated:
        #   selfHeal: true
        syncOptions:
        - CreateNamespace=true
        - ApplyOutOfSyncOnly=true
  syncPolicy:
    preserveResourcesOnDeletion: true
    # automated:
    #   selfHeal: true
