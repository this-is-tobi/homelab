# Installation

The whole installation is performed with [ansible](https://www.ansible.com/) so it is required to install it on the computer that will run playbooks. Also, ssh access to all hosts need to be setup.

> __*Notes*__: 
> 
> *Don't forget to replace `domain.com` and `domain.local` with the appropriate domain. This can be setup in the the [all.yml](../ansible/inventory-example/group_vars/all.yml) file.*

## Prerequisites

For convenience, it is recommended to do these prerequisite steps :

```sh
# Add gateway into /etc/hosts
[ ! $(sudo grep -q "192.168.0.110" /etc/hosts) ] && sudo sh -c "echo $'\n# Homelab\n192.168.0.110   crowdsec.domain.local haproxy.domain.local longhorn.domain.local traefik.domain.local' >> /etc/hosts"

# Copy inventory example to inventory
cp -R ./ansible/inventory-example ./ansible/inventory
```

Because crowdsec is used as the firewall, it is required to [create an account](https://app.crowdsec.net/) to share attack detection on the local network with the community as the community share it with us.

## Settings

Update the [hosts file](../ansible/inventory-example/hosts.yml) and [group_vars files](../ansible/inventory-example/group_vars/) to provide the appropriate infra and services settings.

To create user access to the bastion, it is required to provide their informations in the `groups_vars/all.yml` file :
- Set `setup: true` to setup the working environment for the given user
- Add users ssh public key following the file structure `./secrets/ssh/<bastion_username>.pub`, this will add the appropriate key in the matching bastion user `authorized_keys`.

> __*Notes*__: 
> 
> *Some values are autogenerated and fetch during the ansible install process (let the empty string in group_vars):*
> - *argocd_password*
> - *grafana_password*
> - *harbor_password*
> - *keycloak_password*
> - *kubernetes_dashboard_token*
> - *k3s_token*
> - *minio_password*

## Deploy

Two playbooks are available, one for [infrastructure](../ansible/infra.yml) installation and another one for [services](../ansible/services.yml) installation.
Various tags are available in the playbooks (*for more details, take a look at the files*), it allows to launch only some part of the installation, the main ones are :

__Infra :__
```sh
# Deploy bastion
./run.sh -p ./ansible/infra.yml -t bastion

# Deploy gateway
./run.sh -p ./ansible/infra.yml -t gateway

# Deploy cluster
./run.sh -p ./ansible/infra.yml -t k3s
```

__Services :__

```sh
# Deploy kubernetes services
./run.sh -p ./ansible/services.yml 
```

> __*Notes*__: 
>
> *By default tag `all` is used so every roles are played on playbooks launch.*
> *Multiple tags can be passed as follows :* `./run.sh -p ./ansible/infra.yml -t gateway,k3s`
> 
> *First gateway init can take a long time to run because of openvpn key genereration (5-10min).*

## Destroy

It is possible to cleanly detroy the k3s cluster by running :

```sh
# Destroy cluster
./run.sh -p ./ansible/infra.yml -t k3s-destroy
```
