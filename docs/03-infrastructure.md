# Infrastructure

## Gateway

A host is configured as the gateway to the local network (*i.e handle all incoming traffic*). It runs various services deployed via docker :

- [Openvpn](https://openvpn.net/) for external access to the local network (*i.e from internet*). An openvpn client conf is generated for each admin user declared in ansible `group_vars`.
- [Haproxy](https://www.haproxy.org/) for loadbalancing all incoming external requests (*ports 80 & 443*) to the k3s cluster and loadbalancing k3s api server (*port 6443*).
- [Crowdsec](https://www.crowdsec.net/) for security purpose as it acts as a community firewall.

## Bastion

A host is configured as the bastion to access kubernetes ressources. As previously mentioned, an openvpn profile conf is autogenerated for every `bastion_users` set in [group_vars/all.yml](../ansible/inventory-example/group_vars/all.yml).

Bastion is available on the local network using ssh :

1. Connect to the vpn using the proper autogenerated openvpn user profile conf.
2. Connect to the bastion using `ssh <username>@<bastion_ip> -i <ssh_key>`.


## K3S cluster

Some hosts are configrured to run [k3s](https://k3s.io) (*Lightweight Kubernetes*) with the following roles :
- 3 x master nodes
- 5 x worker nodes

The cluster comes with k3s integrated [klipper](https://github.com/k3s-io/klipper-lb) loadbalancer and [traefik](https://traefik.io/) ingressController.

The following services are deployed in the cluster :

| Name                                                            | Description                            | Helm chart                                                                                                    |
| --------------------------------------------------------------- | -------------------------------------- | ------------------------------------------------------------------------------------------------------------- |
| [ArgoCD](https://argo-cd.readthedocs.io/en/stable/)             | GitOps continuous delivery tool        | [bitnami/argo-cd](https://artifacthub.io/packages/helm/bitnami/argo-cd)                                       |
| [Cert-manager](https://cert-manager.io/)                        | Cloud native certificate management    | [cert-manager/cert-manager](https://artifacthub.io/packages/helm/cert-manager/cert-manager)                   |
| [Grafana](https://grafana.com/)                                 | Observability dashboards               | [bitnami/grafana](https://artifacthub.io/packages/helm/bitnami/grafana)                                       |
| [Harbor](https://goharbor.io/)                                  | Cloud native registry                  | [bitnami/harbor](https://artifacthub.io/packages/helm/bitnami/harbor)                                         |
| [Kubernetes-dashboard](https://github.com/kubernetes/dashboard) | Kubernetes dashboard                   | [k8s-dashboard/kubernetes-dashboard](https://artifacthub.io/packages/helm/k8s-dashboard/kubernetes-dashboard) |
| [Longhorn](https://longhorn.io/)                                | Cloud native distributed block storage | [longhorn/longhorn](https://artifacthub.io/packages/helm/longhorn/longhorn)                                   |
| [Minio](https://min.io/)                                        | High Performance Object Storage        | [bitnami/minio](https://artifacthub.io/packages/helm/bitnami/minio)                                           |
| [Prometheus](https://prometheus.io/)                            | Open-source monitoring solution        | [bitnami/kube-prometheus](https://artifacthub.io/packages/helm/bitnami/kube-prometheus)                       |
