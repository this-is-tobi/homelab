gitea:
  ingress:
    hosts:
    - host: "git.ohmlab.fr"
      paths:
      - path: "/"
        pathType: "Prefix"
    tls:
    - secretName: "git.ohmlab.fr-tls"
      hosts:
      - "git.ohmlab.fr"
  gitea:
    admin:
      username: "admin"
      email: "admin@ohmlab.fr"
      existingSecret: "gitea-admin"
    oauth: []
    config:
      database:
        HOST: "gitea-pg-cluster-rw"
        NAME: "gitea"
        USER: "gitea"
      server:
        DOMAIN: "git.ohmlab.fr"
        ROOT_URL: "https://git.ohmlab.fr"
      openid:
        WHITELISTED_URIS: "sso.ohmlab.fr"
    additionalConfigSources: []
    # - secret:
    #     secretName: "gitea-app-ini-oauth"
    # - configMap:
    #     name: "gitea-app-ini-plaintext"
    additionalConfigFromEnvs:
    - name: "GITEA__openid__ENABLE_OPENID_SIGNIN"
      value: "false"
    - name: "GITEA__openid__ENABLE_OPENID_SIGNUP"
      value: "false"
    - name: "GITEA__oauth2_client__ENABLE"
      value: "true"
    - name: "GITEA__oauth2_client__ENABLE_AUTO_REGISTRATION"
      value: "true"
    - name: "GITEA__oauth2_client__REGISTER_EMAIL_CONFIRM"
      value: "false"
    - name: "GITEA__oauth2_client__PROVIDER_NAME"
      value: "Keycloak"
    - name: "GITEA__oauth2_client__ISSUER_URL"
      value: "https://sso.ohmlab.fr/realms/homelab"
    - name: "GITEA__oauth2_client__AUTO_DISCOVER_URL"
      value: "https://sso.ohmlab.fr/realms/homelab/.well-known/openid-configuration"
    - name: "GITEA__oauth2_client__USE_ADMIN_GROUP"
      value: "true"
    - name: "GITEA__oauth2_client__OPENID_CONNECT_SCOPES"
      value: "openid profile email roles groups"
    - name: "GITEA__oauth2_client__ACCOUNT_LINKING"
      value: "auto"
    - name: "GITEA__oauth2_client__USERNAME"
      value: "preferred_username"
    - name: "GITEA__database__PASSWD"
      valueFrom:
        secretKeyRef:
          name: "gitea-pg-cluster-app"
          key: "password"
    - name: "GITEA__oauth2_client__CLIENT_ID"
      valueFrom:
        secretKeyRef:
          name: "gitea-sso"
          key: "OIDC_CLIENT_ID"
    - name: "GITEA__oauth2_client__CLIENT_SECRET"
      valueFrom:
        secretKeyRef:
          name: "gitea-sso"
          key: "OIDC_CLIENT_SECRET"

cnpg:
  mode: "primary"
  credentials:
    existingSecrets:
      enabled: true
      postgres:
        secretName: "gitea-pg-cluster-admin"
      app:
        secretName: "gitea-pg-cluster-app"
  backup:
    enabled: true
    endpointURL: "https://s3.fr-par.scw.cloud"
    destinationPath: "s3://ohmlab-backups/cnpg"
    s3Credentials:
      create: false
      secretName: "gitea-pg-cluster-backup"
      accessKeyId:
        key: "S3_ACCESS_KEY"
      secretAccessKey:
        key: "S3_SECRET_KEY"
      region:
        key: "S3_REGION"

vso:
  vaultStaticSecrets:
    giteaAdmin:
      mount: "homelab"
      path: "platforms/production/gitea"
    giteaDbInfos:
      mount: "homelab"
      path: "platforms/production/gitea"
    giteaDbAdmin:
      mount: "homelab"
      path: "platforms/production/gitea"
    giteaDbApp:
      mount: "homelab"
      path: "platforms/production/gitea"
    giteaPgBackup:
      mount: "homelab"
      path: "platforms/production/gitea"
    giteaSso:
      mount: "homelab"
      path: "platforms/production/gitea"
