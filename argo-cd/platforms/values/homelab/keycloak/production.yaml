keycloak:
  keycloak:
    hostnameAdmin: "https://sso.ohmlab.fr"
    hostname: "https://sso.ohmlab.fr"
    existingSecret: "keycloak-admin"
    secretKeys:
      adminPasswordKey: "password"
  database:
    host: "keycloak-pg-cluster-rw"
    port: "5432"
    name: "keycloak"
    existingSecret: "keycloak-pg-cluster-app"
    secretKeys:
      usernameKey: "username"
      passwordKey: "password"
  ingress:
    hosts:
    - host: "sso.ohmlab.fr"
      paths:
      - path: "/"
        pathType: "Prefix"
    tls:
    - secretName: "sso.ohmlab.fr-tls"
      hosts:
      - "sso.ohmlab.fr"

cnpg:
  mode: "primary"
  credentials:
    existingSecrets:
      enabled: true
      postgres:
        secretName: "keycloak-pg-cluster-admin"
      app:
        secretName: "keycloak-pg-cluster-app"
  backup:
    enabled: true
    endpointURL: "https://s3.fr-par.scw.cloud"
    destinationPath: "s3://ohmlab-backups/cnpg"
    s3Credentials:
      create: false
      secretName: "keycloak-pg-cluster-backup"
      accessKeyId:
        key: "S3_ACCESS_KEY"
      secretAccessKey:
        key: "S3_SECRET_KEY"
      region:
        key: "S3_REGION"

vso:
  vaultAuth:
    default:
      method: "kubernetes"
      mount: "kubernetes"
      kubernetes:
        role: "keycloak"
        serviceAccount: "default"
  vaultConnection:
    default:
      address: "https://vault.vault-operator-system.svc.cluster.local:8200"
      skipTLSVerify: true
  vaultStaticSecrets:
    keycloakAdmin:
      mount: "homelab"
      path: "platforms/production/keycloak"
      type: "kv-v2"
      vaultAuthRef: "keycloak-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "keycloak-admin"
        create: true
        type: "kubernetes.io/basic-auth"
        transformation:
          excludes:
          - ".*"
          templates:
            username:
              text: '{{ get .Secrets "admin" | dig "username" "" }}'
            password:
              text: '{{ get .Secrets "admin" | dig "password" "" }}'
    keycloakConfig:
      mount: "homelab"
      path: "platforms/production/keycloak"
      type: "kv-v2"
      vaultAuthRef: "keycloak-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "keycloak-config"
        create: true
        type: "Opaque"
        transformation:
          excludes:
          - ".*"
          templates:
            ROOT_DOMAIN:
              text: '{{ get .Secrets "extras" | dig "rootDomain" "" }}'
            KEYCLOAK_DOMAIN:
              text: '{{ get .Secrets "domain" }}'
            KEYCLOAK_REALM:
              text: '{{ get .Secrets "extras" | dig "realm" "" }}'
    keycloakDbInfos:
      mount: "homelab"
      path: "platforms/production/keycloak"
      type: "kv-v2"
      vaultAuthRef: "keycloak-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "keycloak-db-infos"
        create: true
        type: "Opaque"
        transformation:
          excludes:
          - ".*"
          templates:
            DB_URL:
              text: 'postgresql://{{ get .Secrets "postgres" | dig "app" "username" "" }}:{{ get .Secrets "postgres" | dig "app" "password" "" }}@{{ get .Secrets "postgres" | dig "host" "" }}:{{ get .Secrets "postgres" | dig "port" "" }}/{{ get .Secrets "postgres" | dig "database" "" }}'
            DB_HOST:
              text: '{{ get .Secrets "postgres" | dig "host" "" }}'
            DB_PORT:
              text: '{{ get .Secrets "postgres" | dig "port" "" }}'
    keycloakDbAdmin:
      mount: "homelab"
      path: "platforms/production/keycloak"
      type: "kv-v2"
      vaultAuthRef: "keycloak-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "keycloak-pg-cluster-admin"
        create: true
        type: "kubernetes.io/basic-auth"
        transformation:
          excludes:
          - ".*"
          templates:
            username:
              text: '{{ get .Secrets "postgres" | dig "admin" "username" "" }}'
            password:
              text: '{{ get .Secrets "postgres" | dig "admin" "password" "" }}'
    keycloakDbApp:
      mount: "homelab"
      path: "platforms/production/keycloak"
      type: "kv-v2"
      vaultAuthRef: "keycloak-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "keycloak-pg-cluster-app"
        create: true
        type: "kubernetes.io/basic-auth"
        transformation:
          excludes:
          - ".*"
          templates:
            username:
              text: '{{ get .Secrets "postgres" | dig "app" "username" "" }}'
            password:
              text: '{{ get .Secrets "postgres" | dig "app" "password" "" }}'
    keycloakPgBackup:
      mount: "homelab"
      path: "platforms/production/keycloak"
      type: "kv-v2"
      vaultAuthRef: "keycloak-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "keycloak-pg-cluster-backup"
        create: true
        type: "Opaque"
        transformation:
          excludes:
          - ".*"
          templates:
            S3_ENDPOINT:
              text: '{{ get .Secrets "postgres" | dig "s3" "endpoint" "" }}'
            S3_BUCKET_NAME:
              text: '{{ get .Secrets "postgres" | dig "s3" "bucketName" "" }}'
            S3_BUCKET_PREFIX:
              text: '{{ get .Secrets "postgres" | dig "s3" "bucketPrefix" "" }}'
            S3_ACCESS_KEY:
              text: '{{ get .Secrets "postgres" | dig "s3" "accessKey" "" }}'
            S3_SECRET_KEY:
              text: '{{ get .Secrets "postgres" | dig "s3" "secretKey" "" }}'
            S3_REGION:
              text: '{{ get .Secrets "postgres" | dig "s3" "region" "" }}'
    clientGitea:
      mount: "homelab"
      path: "platforms/production/gitea"
      type: "kv-v2"
      vaultAuthRef: "keycloak-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "keycloak-clients-gitea"
        create: true
        type: "Opaque"
        transformation:
          excludes:
          - ".*"
          templates:
            CLIENT_ID:
              text: '{{ get .Secrets "keycloak" | dig "clientId" "" }}'
            CLIENT_SECRET:
              text: '{{ get .Secrets "keycloak" | dig "clientSecret" "" }}'
    clientGrafana:
      mount: "homelab"
      path: "platforms/production/prometheus-stack"
      type: "kv-v2"
      vaultAuthRef: "keycloak-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "keycloak-clients-grafana"
        create: true
        type: "Opaque"
        transformation:
          excludes:
          - ".*"
          templates:
            CLIENT_ID:
              text: '{{ get .Secrets "keycloak" | dig "clientId" "" }}'
            CLIENT_SECRET:
              text: '{{ get .Secrets "keycloak" | dig "clientSecret" "" }}'
    clientArgoCd:
      mount: "homelab"
      path: "platforms/production/argo-cd"
      type: "kv-v2"
      vaultAuthRef: "keycloak-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "keycloak-clients-argocd"
        create: true
        type: "Opaque"
        transformation:
          excludes:
          - ".*"
          templates:
            CLIENT_ID:
              text: '{{ get .Secrets "keycloak" | dig "clientId" "" }}'
            CLIENT_SECRET:
              text: '{{ get .Secrets "keycloak" | dig "clientSecret" "" }}'
    clientMinio:
      mount: "homelab"
      path: "platforms/production/minio"
      type: "kv-v2"
      vaultAuthRef: "keycloak-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "keycloak-clients-minio"
        create: true
        type: "Opaque"
        transformation:
          excludes:
          - ".*"
          templates:
            CLIENT_ID:
              text: '{{ get .Secrets "keycloak" | dig "clientId" "" }}'
            CLIENT_SECRET:
              text: '{{ get .Secrets "keycloak" | dig "clientSecret" "" }}'
    # clientArgoWorkflows:
    #   mount: "homelab"
    #   path: "platforms/production/argo-workflows"
    #   type: "kv-v2"
    #   vaultAuthRef: "keycloak-vso-default"
    #   refreshAfter: "1h"
    #   hmacSecretData: true
    #   destination:
    #     name: "keycloak-clients-argoworkflows"
    #     create: true
    #     type: "Opaque"
    #     transformation:
    #       excludes:
    #       - ".*"
    #       templates:
    #         CLIENT_ID:
    #           text: '{{ get .Secrets "keycloak" | dig "clientId" "" }}'
    #         CLIENT_SECRET:
    #           text: '{{ get .Secrets "keycloak" | dig "clientSecret" "" }}'
    # clientCoder:
    #   mount: "homelab"
    #   path: "platforms/production/coder"
    #   type: "kv-v2"
    #   vaultAuthRef: "keycloak-vso-default"
    #   refreshAfter: "1h"
    #   hmacSecretData: true
    #   destination:
    #     name: "keycloak-clients-coder"
    #     create: true
    #     type: "Opaque"
    #     transformation:
    #       excludes:
    #       - ".*"
    #       templates:
    #         CLIENT_ID:
    #           text: '{{ get .Secrets "keycloak" | dig "clientId" "" }}'
    #         CLIENT_SECRET:
    #           text: '{{ get .Secrets "keycloak" | dig "clientSecret" "" }}'
    # clientOutline:
    #   mount: "homelab"
    #   path: "platforms/production/outline"
    #   type: "kv-v2"
    #   vaultAuthRef: "keycloak-vso-default"
    #   refreshAfter: "1h"
    #   hmacSecretData: true
    #   destination:
    #     name: "keycloak-clients-outline"
    #     create: true
    #     type: "Opaque"
    #     transformation:
    #       excludes:
    #       - ".*"
    #       templates:
    #         CLIENT_ID:
    #           text: '{{ get .Secrets "keycloak" | dig "clientId" "" }}'
    #         CLIENT_SECRET:
    #           text: '{{ get .Secrets "keycloak" | dig "clientSecret" "" }}'
    # clientMLflow:
    #   mount: "homelab"
    #   path: "platforms/production/mlflow"
    #   type: "kv-v2"
    #   vaultAuthRef: "keycloak-vso-default"
    #   refreshAfter: "1h"
    #   hmacSecretData: true
    #   destination:
    #     name: "keycloak-clients-mlflow"
    #     create: true
    #     type: "Opaque"
    #     transformation:
    #       excludes:
    #       - ".*"
    #       templates:
    #         CLIENT_ID:
    #           text: '{{ get .Secrets "keycloak" | dig "clientId" "" }}'
    #         CLIENT_SECRET:
    #           text: '{{ get .Secrets "keycloak" | dig "clientSecret" "" }}'
    # clientSonarQube:
    #   mount: "homelab"
    #   path: "platforms/production/sonarqube"
    #   type: "kv-v2"
    #   vaultAuthRef: "keycloak-vso-default"
    #   refreshAfter: "1h"
    #   hmacSecretData: true
    #   destination:
    #     name: "keycloak-clients-sonarqube"
    #     create: true
    #     type: "Opaque"
    #     transformation:
    #       excludes:
    #       - ".*"
    #       templates:
    #         CLIENT_ID:
    #           text: '{{ get .Secrets "keycloak" | dig "clientId" "" }}'
    #         CLIENT_SECRET:
    #           text: '{{ get .Secrets "keycloak" | dig "clientSecret" "" }}'
    # clientHarbor:
    #   mount: "homelab"
    #   path: "platforms/production/harbor"
    #   type: "kv-v2"
    #   vaultAuthRef: "keycloak-vso-default"
    #   refreshAfter: "1h"
    #   hmacSecretData: true
    #   destination:
    #     name: "keycloak-clients-harbor"
    #     create: true
    #     type: "Opaque"
    #     transformation:
    #       excludes:
    #       - ".*"
    #       templates:
    #         CLIENT_ID:
    #           text: '{{ get .Secrets "keycloak" | dig "clientId" "" }}'
    #         CLIENT_SECRET:
    #           text: '{{ get .Secrets "keycloak" | dig "clientSecret" "" }}'
    # clientVaultwarden:
    #   mount: "homelab"
    #   path: "platforms/production/vaultwarden"
    #   type: "kv-v2"
    #   vaultAuthRef: "keycloak-vso-default"
    #   refreshAfter: "1h"
    #   hmacSecretData: true
    #   destination:
    #     name: "keycloak-clients-vaultwarden"
    #     create: true
    #     type: "Opaque"
    #     transformation:
    #       excludes:
    #       - ".*"
    #       templates:
    #         CLIENT_ID:
    #           text: '{{ get .Secrets "keycloak" | dig "clientId" "" }}'
    #         CLIENT_SECRET:
    #           text: '{{ get .Secrets "keycloak" | dig "clientSecret" "" }}'
