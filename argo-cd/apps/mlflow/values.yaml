mlflow:
  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-http-prod
      traefik.ingress.kubernetes.io/router.middlewares: mlflow-oauth2-proxy@kubernetescrd
    hosts:
    - host: ""
      paths:
      - path: /
        pathType: ImplementationSpecific
    tls:
    - hosts:
      - ""
      secretName: ""
  service:
    annotations:
      traefik.ingress.kubernetes.io/service.passhostheader: "true"
  backendStore:
    databaseConnectionCheck: true
    postgres:
      enabled: true
      host: ""
      port: 5432
      database: ""
      user: ""
      password: ""
  artifactRoot:
    proxiedArtifactStorage: false
    s3:
      enabled: true
      bucket: ""
      path: ""
      awsAccessKeyId: ""
      awsSecretAccessKey: ""
  extraEnvVars:
    MLFLOW_S3_ENDPOINT_URL: ""
    AWS_DEFAULT_REGION: ""
  resources:
    requests:
      memory: 512Mi
      cpu: 250m
    limits:
      memory: 1Gi
      cpu: "1"

cnpg:
  fullnameOverride: mlflow-pg-cluster
  imageName: ghcr.io/cloudnative-pg/postgresql:17.7
  mode: primary
  dbName: mlflow
  credentials:
    username: mlflow
    password: ""
    postgresPassword: ""
  instances: 3
  pvcSize:
    data: 3Gi
    wal: 3Gi
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  affinity:
    topologyKey: kubernetes.io/hostname
  backup:
    enabled: false
    legacyMode: false
    endpointURL: ""
    destinationPath: "s3://<bucket>/<prefix>"
    cron: 0 0 0 * * *
    retentionPolicy: 30d
    compression: gzip
    s3Credentials:
      create: true
      secretName: mlflow-pg-cluster-backup
      accessKeyId:
        key: accessKeyId
        value: ""
      secretAccessKey:
        key: secretAccessKey
        value: ""
      region:
        key: region
        value: ""

sso:
  config:
    clientID: ""
    clientSecret: ""
    cookieSecret: ""
    configFile: |-
      provider = "keycloak-oidc"
      provider_display_name = "Keycloak"
      email_domains = [ "*" ]
      upstreams = [ "http://mlflow.mlflow.svc.cluster.local:5000/" ]
      redirect_url = ""
      oidc_issuer_url = ""
  ingress:
    enabled: true
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-http-prod
    path: /oauth2
    hosts:
    - ""
    tls:
    - secretName: ""
      hosts:
      - ""

vso:
  vaultAuth:
    default:
      method: "kubernetes"
      mount: "kubernetes"
      kubernetes:
        role: "mlflow"
        serviceAccount: "default"
  vaultConnection:
    default:
      address: "https://vault.vault-operator-system.svc.cluster.local:8200"
      skipTLSVerify: true
  vaultStaticSecrets:
    mlflowAdmin:
      mount: ""
      path: ""
      type: "kv-v2"
      vaultAuthRef: "mlflow-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "mlflow-admin"
        create: true
        type: "Opaque"
        transformation:
          excludes:
          - ".*"
          templates:
            username:
              text: '{{ get .Secrets "admin" | dig "username" "" }}'
            password:
              text: '{{ get .Secrets "admin" | dig "password" "" }}'
    mlflowS3:
      mount: ""
      path: ""
      type: "kv-v2"
      vaultAuthRef: "mlflow-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "mlflow-s3"
        create: true
        type: "Opaque"
        transformation:
          excludes:
          - ".*"
          templates:
            S3_ENDPOINT:
              text: '{{ get .Secrets "s3" | dig "endpoint" "" }}'
            S3_BUCKET_NAME:
              text: '{{ get .Secrets "s3" | dig "bucketName" "" }}'
            S3_BUCKET_PREFIX:
              text: '{{ get .Secrets "s3" | dig "bucketPrefix" "" }}'
            S3_ACCESS_KEY:
              text: '{{ get .Secrets "s3" | dig "accessKey" "" }}'
            S3_SECRET_KEY:
              text: '{{ get .Secrets "s3" | dig "secretKey" "" }}'
            S3_REGION:
              text: '{{ get .Secrets "s3" | dig "region" "" }}'
    mlflowDbInfos:
      mount: ""
      path: ""
      type: "kv-v2"
      vaultAuthRef: "mlflow-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "mlflow-db-infos"
        create: true
        type: "Opaque"
        transformation:
          excludes:
          - ".*"
          templates:
            DB_URL:
              text: 'postgresql://{{ get .Secrets "postgres" | dig "app" "username" "" }}:{{ get .Secrets "postgres" | dig "app" "password" "" }}@{{ get .Secrets "postgres" | dig "host" "" }}:{{ get .Secrets "postgres" | dig "port" "" }}/{{ get .Secrets "postgres" | dig "database" "" }}'
            DB_HOST:
              text: '{{ get .Secrets "postgres" | dig "host" "" }}'
            DB_PORT:
              text: '{{ get .Secrets "postgres" | dig "port" "" }}'
    mlflowDbAdmin:
      mount: ""
      path: ""
      type: "kv-v2"
      vaultAuthRef: "mlflow-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "mlflow-pg-cluster-admin"
        create: true
        type: "kubernetes.io/basic-auth"
        transformation:
          excludes:
          - ".*"
          templates:
            username:
              text: '{{ get .Secrets "postgres" | dig "admin" "username" "" }}'
            password:
              text: '{{ get .Secrets "postgres" | dig "admin" "password" "" }}'
    mlflowDbApp:
      mount: ""
      path: ""
      type: "kv-v2"
      vaultAuthRef: "mlflow-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "mlflow-pg-cluster-app"
        create: true
        type: "kubernetes.io/basic-auth"
        transformation:
          excludes:
          - ".*"
          templates:
            username:
              text: '{{ get .Secrets "postgres" | dig "app" "username" "" }}'
            password:
              text: '{{ get .Secrets "postgres" | dig "app" "password" "" }}'
    mlflowPgBackup:
      mount: ""
      path: ""
      type: "kv-v2"
      vaultAuthRef: "mlflow-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "mlflow-pg-cluster-backup"
        create: true
        type: "Opaque"
        transformation:
          excludes:
          - ".*"
          templates:
            S3_ENDPOINT:
              text: '{{ get .Secrets "postgres" | dig "s3" "endpoint" "" }}'
            S3_BUCKET_NAME:
              text: '{{ get .Secrets "postgres" | dig "s3" "bucketName" "" }}'
            S3_BUCKET_PREFIX:
              text: '{{ get .Secrets "postgres" | dig "s3" "bucketPrefix" "" }}'
            S3_ACCESS_KEY:
              text: '{{ get .Secrets "postgres" | dig "s3" "accessKey" "" }}'
            S3_SECRET_KEY:
              text: '{{ get .Secrets "postgres" | dig "s3" "secretKey" "" }}'
            S3_REGION:
              text: '{{ get .Secrets "postgres" | dig "s3" "region" "" }}'
    mlflowSso:
      mount: ""
      path: ""
      type: "kv-v2"
      vaultAuthRef: "mlflow-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "mlflow-sso"
        create: true
        type: "Opaque"
        transformation:
          excludes:
          - ".*"
          templates:
            OIDC_CLIENT_ID:
              text: '{{ get .Secrets "keycloak" | dig "clientId" "" }}'
            OIDC_CLIENT_SECRET:
              text: '{{ get .Secrets "keycloak" | dig "clientSecret" "" }}'
