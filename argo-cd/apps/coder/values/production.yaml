coder:
  coder:
    ingress:
      host: "coder.ohmlab.fr"
      wildcardHost: "*.coder.ohmlab.fr"
      tls:
        secretName: "coder.ohmlab.fr-tls"
        wildcardSecretName: "coder.ohmlab.fr-tls-wild"
    envUseClusterAccessURL: false
    env:
    - name: "CODER_PG_CONNECTION_URL"
      valueFrom:
        secretKeyRef:
          name: "coder-db-infos"
          key: "DB_URL"
    - name: "CODER_ACCESS_URL"
      value: "https://coder.ohmlab.fr"
    - name: "CODER_OIDC_ISSUER_URL"
      value: "https://keycloak.ohmlab.fr/realms/homelab"
    - name: "CODER_OIDC_CLIENT_ID"
      valueFrom:
        secretKeyRef:
          name: "coder-sso"
          key: "OIDC_CLIENT_ID"
    - name: "CODER_OIDC_CLIENT_SECRET"
      valueFrom:
        secretKeyRef:
          name: "coder-sso"
          key: "OIDC_CLIENT_SECRET"
    - name: "CODER_OIDC_SIGN_IN_TEXT"
      value: "Login with Keycloak"
    - name: "CODER_OIDC_SCOPES"
      value: "openid,profile,email,groups,roles"
    - name: "CODER_OIDC_GROUP_FIELD"
      value: "groups"
    - name: "CODER_OIDC_ADMIN_GROUP"
      value: "admin"
    - name: "CODER_OIDC_GROUP_AUTO_CREATE"
      value: "true"
    envFrom: []
    # - configMapRef:
    #     name: coder-config
    # - secretRef:
    #     name: coder-config
    # - secretRef:
    #     name: coder-sso

cnpg:
  mode: "primary"
  credentials:
    existingSecrets:
      enabled: true
      postgres:
        secretName: "coder-pg-cluster-admin"
      app:
        secretName: "coder-pg-cluster-app"
  backup:
    enabled: true
    endpointURL: "https://s3.fr-par.scw.cloud"
    destinationPath: "s3://ohmlab-backups/cnpg"
    s3Credentials:
      create: false
      secretName: "coder-pg-cluster-backup"
      accessKeyId:
        key: "S3_ACCESS_KEY"
      secretAccessKey:
        key: "S3_SECRET_KEY"
      region:
        key: "S3_REGION"

vso:
  vaultAuth:
    default:
      method: "kubernetes"
      mount: "kubernetes"
      kubernetes:
        role: "coder"
        serviceAccount: "coder"
  vaultConnection:
    default:
      address: "https://vault.vault-operator-system.svc.cluster.local:8200"
      skipTLSVerify: true
  vaultStaticSecrets:
    coderDbInfos:
      mount: "homelab"
      path: "platforms/production/coder"
      type: "kv-v2"
      vaultAuthRef: "coder-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "coder-db-infos"
        create: true
        type: "Opaque"
        transformation:
          excludes:
          - ".*"
          templates:
            DB_URL:
              text: '{{ get .Secrets "postgres" | dig "connectionString" "" }}'
    coderDbAdmin:
      mount: "homelab"
      path: "platforms/production/coder"
      type: "kv-v2"
      vaultAuthRef: "coder-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "coder-pg-cluster-admin"
        create: true
        type: "kubernetes.io/basic-auth"
        transformation:
          excludes:
          - ".*"
          templates:
            username:
              text: '{{ get .Secrets "postgres" | dig "admin" "username" "" }}'
            password:
              text: '{{ get .Secrets "postgres" | dig "admin" "password" "" }}'
    coderDbApp:
      mount: "homelab"
      path: "platforms/production/coder"
      type: "kv-v2"
      vaultAuthRef: "coder-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "coder-pg-cluster-app"
        create: true
        type: "kubernetes.io/basic-auth"
        transformation:
          excludes:
          - ".*"
          templates:
            username:
              text: '{{ get .Secrets "postgres" | dig "app" "username" "" }}'
            password:
              text: '{{ get .Secrets "postgres" | dig "app" "password" "" }}'
    coderPgBackup:
      mount: "homelab"
      path: "platforms/production/coder"
      type: "kv-v2"
      vaultAuthRef: "coder-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "coder-pg-cluster-backup"
        create: true
        type: "Opaque"
        transformation:
          excludes:
          - ".*"
          templates:
            S3_ENDPOINT:
              text: '{{ get .Secrets "postgres" | dig "s3" "endpoint" "" }}'
            S3_BUCKET_NAME:
              text: '{{ get .Secrets "postgres" | dig "s3" "bucketName" "" }}'
            S3_BUCKET_PREFIX:
              text: '{{ get .Secrets "postgres" | dig "s3" "bucketPrefix" "" }}'
            S3_ACCESS_KEY:
              text: '{{ get .Secrets "postgres" | dig "s3" "accessKey" "" }}'
            S3_SECRET_KEY:
              text: '{{ get .Secrets "postgres" | dig "s3" "secretKey" "" }}'
            S3_REGION:
              text: '{{ get .Secrets "postgres" | dig "s3" "region" "" }}'
    coderSso:
      mount: "homelab"
      path: "platforms/production/coder"
      type: "kv-v2"
      vaultAuthRef: "coder-vso-default"
      refreshAfter: "1h"
      hmacSecretData: true
      destination:
        name: "coder-sso"
        create: true
        type: "Opaque"
        transformation:
          excludes:
          - ".*"
          templates:
            OIDC_CLIENT_ID:
              text: '{{ get .Secrets "keycloak" | dig "clientId" "" }}'
            OIDC_CLIENT_SECRET:
              text: '{{ get .Secrets "keycloak" | dig "clientSecret" "" }}'
