# Bank Vaults Operator Configuration
vault-operator:
  replicaCount: 1
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi
  webhook:
    enabled: true
    replicas: 2
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

vault:
  enabled: true
  name: "vault"
  size: 3
  image:
    repository: "hashicorp/vault"
    tag: "1.20.1"
  bankVaultsImage: "ghcr.io/bank-vaults/bank-vaults:latest"
  service:
    type: "ClusterIP"
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "9102"
  storage:
    raft:
      enabled: true
      size: "10Gi"
      storageClass: "longhorn"
  unseal:
    kubernetes:
      enabled: true
      secretName: "vault-unseal-keys"
  config:
    ui: true
    tls:
      enabled: true
    telemetry:
      unauthenticated: false
      retention: "10m"
      disableHostname: true
  externalConfig:
    policies:
    - name: "vault-init-secrets"
      rules: |
        # Allow creating/updating secrets in platforms/production path
        path "homelab/data/*" {
          capabilities = ["create", "update", "read"]
        }
        # Allow listing to check if secrets exist
        path "homelab/metadata/*" {
          capabilities = ["list", "read"]
        }
    - name: "argo-cd"
      rules: |
        path "homelab/data/platforms/production/argo-cd" {
          capabilities = ["read", "list"]
        }
    - name: "cert-manager"
      rules: |
        path "homelab/data/platforms/production/cert-manager" {
          capabilities = ["read", "list"]
        }
    - name: "coder"
      rules: |
        path "homelab/data/platforms/production/coder" {
          capabilities = ["read", "list"]
        }
    - name: "gitea"
      rules: |
        path "homelab/data/platforms/production/gitea" {
          capabilities = ["read", "list"]
        }
    - name: "harbor"
      rules: |
        path "homelab/data/platforms/production/harbor" {
          capabilities = ["read", "list"]
        }
    - name: "keycloak"
      rules: |
        path "homelab/data/platforms/production/keycloak" {
          capabilities = ["read", "list"]
        }
        path "homelab/data/platforms/production/argo-cd" {
          capabilities = ["read", "list"]
          allowed_parameters = {
            "data/keycloak/clientId" = []
            "data/keycloak/clientSecret" = []
          }
        }
        path "homelab/data/platforms/production/argo-workflows" {
          capabilities = ["read", "list"]
          allowed_parameters = {
            "data/keycloak/clientId" = []
            "data/keycloak/clientSecret" = []
          }
        }
        path "homelab/data/platforms/production/coder" {
          capabilities = ["read", "list"]
          allowed_parameters = {
            "data/keycloak/clientId" = []
            "data/keycloak/clientSecret" = []
          }
        }
        path "homelab/data/platforms/production/minio" {
          capabilities = ["read", "list"]
          allowed_parameters = {
            "data/keycloak/clientId" = []
            "data/keycloak/clientSecret" = []
          }
        }
        path "homelab/data/platforms/production/rustfs" {
          capabilities = ["read", "list"]
          allowed_parameters = {
            "data/keycloak/clientId" = []
            "data/keycloak/clientSecret" = []
          }
        }
        path "homelab/data/platforms/production/gitea" {
          capabilities = ["read", "list"]
          allowed_parameters = {
            "data/keycloak/clientId" = []
            "data/keycloak/clientSecret" = []
          }
        }
        path "homelab/data/platforms/production/harbor" {
          capabilities = ["read", "list"]
          allowed_parameters = {
            "data/keycloak/clientId" = []
            "data/keycloak/clientSecret" = []
          }
        }
        path "homelab/data/platforms/production/mlflow" {
          capabilities = ["read", "list"]
          allowed_parameters = {
            "data/keycloak/clientId" = []
            "data/keycloak/clientSecret" = []
          }
        }
        path "homelab/data/platforms/production/mattermost" {
          capabilities = ["read", "list"]
          allowed_parameters = {
            "data/keycloak/clientId" = []
            "data/keycloak/clientSecret" = []
          }
        }
        path "homelab/data/platforms/production/outline" {
          capabilities = ["read", "list"]
          allowed_parameters = {
            "data/keycloak/clientId" = []
            "data/keycloak/clientSecret" = []
          }
        }
        path "homelab/data/platforms/production/sonarqube" {
          capabilities = ["read", "list"]
          allowed_parameters = {
            "data/keycloak/clientId" = []
            "data/keycloak/clientSecret" = []
          }
        }
        path "homelab/data/platforms/production/vault" {
          capabilities = ["read", "list"]
          allowed_parameters = {
            "data/keycloak/clientId" = []
            "data/keycloak/clientSecret" = []
          }
        }
        path "homelab/data/platforms/production/vaultwarden" {
          capabilities = ["read", "list"]
          allowed_parameters = {
            "data/keycloak/clientId" = []
            "data/keycloak/clientSecret" = []
          }
        }
        path "homelab/data/platforms/production/prometheus-stack" {
          capabilities = ["read", "list"]
          allowed_parameters = {
            "data/keycloak/clientId" = []
            "data/keycloak/clientSecret" = []
          }
        }
    - name: "mattermost"
      rules: |
        path "homelab/data/platforms/production/mattermost" {
          capabilities = ["read", "list"]
        }
    - name: "minio"
      rules: |
        path "homelab/data/platforms/production/minio" {
          capabilities = ["read", "list"]
        }
    - name: "rustfs"
      rules: |
        path "homelab/data/platforms/production/rustfs" {
          capabilities = ["read", "list"]
        }
    - name: "outline"
      rules: |
        path "homelab/data/platforms/production/outline" {
          capabilities = ["read", "list"]
        }
    - name: "prometheus-stack"
      rules: |
        path "homelab/data/platforms/production/prometheus-stack" {
          capabilities = ["read", "list"]
        }
    - name: "sonarqube"
      rules: |
        path "homelab/data/platforms/production/sonarqube" {
          capabilities = ["read", "list"]
        }
    - name: "sops"
      rules: |
        path "homelab/data/platforms/production/sops" {
          capabilities = ["read", "list"]
        }
    auth:
    - type: "kubernetes"
      roles:
      - name: "vault-init-secrets"
        bound_service_account_names: ["vault-init-secrets"]
        bound_service_account_namespaces: ["vault-operator-system"]
        policies: ["vault-init-secrets"]
        ttl: "10m"
      - name: "argo-cd"
        bound_service_account_names: ["default"]
        bound_service_account_namespaces: ["argo-cd"]
        policies: ["argo-cd"]
        ttl: "1h"
      - name: "cert-manager"
        bound_service_account_names: ["default"]
        bound_service_account_namespaces: ["cert-manager"]
        policies: ["cert-manager"]
        ttl: "1h"
      - name: "coder"
        bound_service_account_names: ["default"]
        bound_service_account_namespaces: ["coder"]
        policies: ["coder"]
        ttl: "1h"
      - name: "gitea"
        bound_service_account_names: ["default"]
        bound_service_account_namespaces: ["gitea"]
        policies: ["gitea"]
        ttl: "1h"
      - name: "harbor"
        bound_service_account_names: ["default"]
        bound_service_account_namespaces: ["harbor"]
        policies: ["harbor"]
        ttl: "1h"
      - name: "keycloak"
        bound_service_account_names: ["default"]
        bound_service_account_namespaces: ["keycloak"]
        policies: ["keycloak"]
        ttl: "1h"
      - name: "mattermost"
        bound_service_account_names: ["default"]
        bound_service_account_namespaces: ["mattermost"]
        policies: ["mattermost"]
        ttl: "1h"
      - name: "minio"
        bound_service_account_names: ["default"]
        bound_service_account_namespaces: ["minio"]
        policies: ["minio"]
        ttl: "1h"
      - name: "rustfs"
        bound_service_account_names: ["default"]
        bound_service_account_namespaces: ["rustfs"]
        policies: ["rustfs"]
        ttl: "1h"
      - name: "outline"
        bound_service_account_names: ["default"]
        bound_service_account_namespaces: ["outline"]
        policies: ["outline"]
        ttl: "1h"
      - name: "prometheus-stack"
        bound_service_account_names: ["default"]
        bound_service_account_namespaces: ["prometheus-stack"]
        policies: ["prometheus-stack"]
        ttl: "1h"
      - name: "sonarqube"
        bound_service_account_names: ["default"]
        bound_service_account_namespaces: ["sonarqube"]
        policies: ["sonarqube"]
        ttl: "1h"
      - name: "sops"
        bound_service_account_names: ["default"]
        bound_service_account_namespaces: ["sops"]
        policies: ["sops"]
        ttl: "1h"
    secrets:
    - path: "homelab"
      type: "kv"
      description: "Homelab secrets KV store"
      options:
        version: 2
  startupSecrets: []
  initSecrets:
    enabled: true
    vaultRole: "vault-init-secrets"
    skipTLSVerify: true
    backoffLimit: 3
    ttlSecondsAfterFinished: 86400
    image: "ghcr.io/this-is-tobi/homelab-utils:latest"
    resources:
      requests:
        cpu: "50m"
        memory: "64Mi"
      limits:
        cpu: "200m"
        memory: "128Mi"
    # Secrets to initialize using template syntax:
    # - <random:N> generates random alphanumeric string of length N
    # - <uuid> generates UUID v4
    # - <age:secret> generates age secret key
    # - <age:public> generates age public key (pair with secret key)
    # - Static values remain as-is
    # Supports nested JSON structure for organizing related secrets
    secrets: []
  resources:
    vault:
      limits:
        cpu: "1"
        memory: "1Gi"
      requests:
        cpu: "500m"
        memory: "512Mi"
    bankVaults:
      limits:
        cpu: "100m"
        memory: "128Mi"
      requests:
        cpu: "50m"
        memory: "64Mi"
  # Note: Vault needs specific capabilities (IPC_LOCK, SETFCAP) which are added by the operator
  # Don't set runAsNonRoot/runAsUser here - let the operator handle it
  securityContext:
    fsGroup: 1000
  serviceAccount: "vault"
  ingress:
    enabled: true
    ingressClassName: "nginx"
    host: "vault.core.ohmlab.fr"
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-http-prod"
      nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    tls:
      enabled: true
      secretName: "vault-ingress-tls"  # Separate from vault-tls (used internally by operator)
  serviceMonitor:
    enabled: true
  statsd:
    enabled: true
    image: "prom/statsd-exporter:latest"
  agent:
    enabled: true

vso:
  enabled: true
  controller:
    replicas: 2
    manager:
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "500m"
      securityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        runAsNonRoot: true
        runAsUser: 65532
        capabilities:
          drop:
          - "ALL"
        seccompProfile:
          type: "RuntimeDefault"
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 65532
      fsGroup: 65532
      seccompProfile:
        type: "RuntimeDefault"
    rbac:
      create: true
    serviceAccount:
      create: true
      name: "vault-secrets-operator"
  defaultVaultConnection:
    enabled: true
    address: "https://vault.vault-operator-system.svc.cluster.local:8200"
    skipTLSVerify: true
  defaultAuthMethod:
    enabled: false
    # Uncomment to enable global auth (not recommended for multi-tenant)
    # namespace: "vault-operator-system"
    # method: kubernetes
    # mount: kubernetes
    # allowedNamespaces: ["*"]
    # kubernetes:
    #   role: "default"  # Must exist in Vault
    #   serviceAccount: default
    #   tokenAudiences: ["vault"]
  metrics:
    service:
      enabled: true
      type: "ClusterIP"
      port: 8080

backup-utils:
  fullnameOverride: "backup"
  enabled: false
  backups:
    vaultSnapshot:
      enabled: true
      type: "vault"
      job:
        schedule: "0 0 * * *"
        successfulJobsHistoryLimit: 3
      env:
        VAULT_ADDR: "https://vault.vault-operator-system.svc.cluster.local:8200"
        # VAULT_EXTRA_ARGS: ""
        VAULT_SKIP_VERIFY: "true"
        S3_PATH_STYLE: "true"
        RETENTION: "30d"
      secrets: {}
        # VAULT_TOKEN: ""
        # S3_ENDPOINT: "https://s3.fr-par.scw.cloud"
        # S3_BUCKET_NAME: "ohmlab-backups"
        # S3_BUCKET_PREFIX: "vault"
        # S3_ACCESS_KEY: ""
        # S3_SECRET_KEY: ""
      envFrom:
      - secretRef:
          name: "vault-backup"

