{{- if and .Values.vault.enabled .Values.vault.initSecrets.enabled }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-init-secrets
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-weight: "-5"
    argocd.argoproj.io/sync-wave: "-1"

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vault-init-secrets
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-weight: "-5"
    argocd.argoproj.io/sync-wave: "-1"
rules:
- apiGroups: [""]
  resources: ["serviceaccounts/token"]
  resourceNames: ["vault-init-secrets"]
  verbs: ["create"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vault-init-secrets
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-weight: "-5"
    argocd.argoproj.io/sync-wave: "-1"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: vault-init-secrets
subjects:
- kind: ServiceAccount
  name: vault-init-secrets
  namespace: {{ .Release.Namespace }}

---
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-init-secrets-{{ .Release.Revision | default "1" }}
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-weight: "10"
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    argocd.argoproj.io/sync-wave: "10"
  labels:
    app.kubernetes.io/name: vault-init-secrets
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  backoffLimit: {{ .Values.vault.initSecrets.backoffLimit | default 3 }}
  ttlSecondsAfterFinished: {{ .Values.vault.initSecrets.ttlSecondsAfterFinished | default 86400 }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: vault-init-secrets
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      serviceAccountName: vault-init-secrets
      restartPolicy: Never
      {{- if .Values.vault.initSecrets.nodeSelector }}
      nodeSelector:
        {{- toYaml .Values.vault.initSecrets.nodeSelector | nindent 8 }}
      {{- end }}
      {{- if .Values.vault.initSecrets.tolerations }}
      tolerations:
        {{- toYaml .Values.vault.initSecrets.tolerations | nindent 8 }}
      {{- end }}
      initContainers:
      - name: wait-for-vault
        image: {{ .Values.vault.initSecrets.image | default "docker.io/curlimages/curl:8.5.0" }}
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Waiting for Vault to be ready..."
          max_attempts=60
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if curl -k -s {{ .Values.vault.initSecrets.vaultAddr | default (printf "https://%s.%s.svc.cluster.local:8200" .Values.vault.name .Release.Namespace) }}/v1/sys/health | grep -q "initialized"; then
              echo "Vault is ready!"
              exit 0
            fi
            echo "Waiting for Vault... (attempt $((attempt+1))/$max_attempts)"
            sleep 5
            attempt=$((attempt+1))
          done

          echo "Timeout waiting for Vault to become ready"
          exit 1
        resources:
          requests:
            cpu: 10m
            memory: 16Mi
          limits:
            cpu: 50m
            memory: 32Mi
      containers:
      - name: init-secrets
        image: {{ .Values.vault.initSecrets.image | default "ghcr.io/this-is-tobi/tools/homelab-utils:latest" }}
        env:
        - name: VAULT_ADDR
          value: {{ .Values.vault.initSecrets.vaultAddr | default (printf "https://%s.%s.svc.cluster.local:8200" .Values.vault.name .Release.Namespace) | quote }}
        - name: VAULT_SKIP_VERIFY
          value: {{ .Values.vault.initSecrets.skipTLSVerify | default "true" | quote }}
        - name: VAULT_ROLE
          value: {{ .Values.vault.initSecrets.vaultRole | default "vault-init-secrets" | quote }}
        - name: NAMESPACE
          value: {{ .Release.Namespace | quote }}
        command:
        - /bin/bash
        - -c
        - |
          set -e

          # Prepare secrets configuration JSON
          cat <<'SECRETS_CONFIG_EOF' > /tmp/secrets-config.json
          [
          {{- range $idx, $secret := .Values.vault.initSecrets.secrets }}
          {{- if $idx }},{{ end }}
          {
            "path": {{ $secret.path | quote }},
            "data": {{ $secret.data | toJson }}
          }
          {{- end }}
          ]
          SECRETS_CONFIG_EOF

          # Run the vault init secrets script
          export SECRETS_FILE=/tmp/secrets-config.json
          ${HOME}/scripts/vault-init-secrets.sh
        resources:
          {{- toYaml .Values.vault.initSecrets.resources | nindent 10 }}
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
          capabilities:
            drop:
            - ALL
          seccompProfile:
            type: RuntimeDefault
        volumeMounts:
        - name: tmp
          mountPath: /tmp
      volumes:
      - name: tmp
        emptyDir: {}
{{- end }}
