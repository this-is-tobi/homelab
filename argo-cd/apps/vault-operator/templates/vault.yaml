{{- if .Values.vault.enabled }}
---
apiVersion: vault.banzaicloud.com/v1alpha1
kind: Vault
metadata:
  name: {{ .Values.vault.name }}
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  # Vault cluster size
  size: {{ .Values.vault.size }}

  # Vault image
  image: {{ .Values.vault.image.repository }}:{{ .Values.vault.image.tag }}

  # Bank Vaults image (sidecar for auto-unseal, config)
  bankVaultsImage: {{ .Values.vault.bankVaultsImage }}

  # Annotations for Vault pods and services
  {{- if or .Values.vault.service.annotations .Values.vault.agent.enabled }}
  vaultAnnotations:
    {{- if .Values.vault.service.annotations }}
    {{- toYaml .Values.vault.service.annotations | nindent 4 }}
    {{- end }}
    {{- if .Values.vault.agent.enabled }}
    vault.security.banzaicloud.io/vault-addr: "https://{{ .Values.vault.name }}:8200"
    vault.security.banzaicloud.io/vault-role: "default"
    vault.security.banzaicloud.io/vault-skip-verify: "{{ not .Values.vault.config.tls.enabled }}"
    {{- end }}
  {{- end }}

  # Service configuration
  serviceType: {{ .Values.vault.service.type }}

  # Storage configuration
  {{- if .Values.vault.storage.raft.enabled }}
  # Integrated storage (Raft)
  volumeClaimTemplates:
    - metadata:
        name: vault-raft
      spec:
        accessModes:
          - ReadWriteOnce
        {{- if .Values.vault.storage.raft.storageClass }}
        storageClassName: {{ .Values.vault.storage.raft.storageClass }}
        {{- end }}
        resources:
          requests:
            storage: {{ .Values.vault.storage.raft.size }}
  {{- end }}

  # Auto-unseal configuration
  unsealConfig:
    {{- if .Values.vault.unseal.kubernetes.enabled }}
    kubernetes:
      secretNamespace: {{ .Release.Namespace }}
      secretName: {{ .Values.vault.unseal.kubernetes.secretName }}
    {{- end }}
    {{- if .Values.vault.unseal.aws }}
    aws:
      {{- toYaml .Values.vault.unseal.aws | nindent 6 }}
    {{- end }}
    {{- if .Values.vault.unseal.gcp }}
    gcp:
      {{- toYaml .Values.vault.unseal.gcp | nindent 6 }}
    {{- end }}
    {{- if .Values.vault.unseal.azure }}
    azure:
      {{- toYaml .Values.vault.unseal.azure | nindent 6 }}
    {{- end }}

  # Vault container security - IPC_LOCK capability for memory locking
  vaultContainerSpec:
    name: vault
    securityContext:
      capabilities:
        add:
          - IPC_LOCK
    volumeMounts:
      - name: vault-config
        mountPath: /vault/config
      - name: vault-raft
        mountPath: /vault/data
    # Health probes - use HTTP when TLS is disabled, HTTPS when enabled
    {{- if not .Values.vault.config.tls.enabled }}
    startupProbe:
      httpGet:
        path: /v1/sys/init
        port: 8200
        scheme: HTTP
      failureThreshold: 18
      periodSeconds: 10
    livenessProbe:
      httpGet:
        path: /v1/sys/health?standbyok=true
        port: 8200
        scheme: HTTP
      periodSeconds: 10
      failureThreshold: 3
    readinessProbe:
      httpGet:
        path: /v1/sys/health?standbyok=true&perfstandbyok=true&drsecondarycode=299
        port: 8200
        scheme: HTTP
      periodSeconds: 5
      failureThreshold: 2
    {{- end }}

  # Vault configuration (HCL)
  config:
    ui: {{ .Values.vault.config.ui }}

    # disable_mlock controls memory locking to prevent sensitive data from swapping to disk
    # false = secure (requires IPC_LOCK capability) - prevents memory swapping
    # true = permissive (no capability needed) - allows memory swapping
    disable_mlock: false

    listener:
      - tcp:
          address: "0.0.0.0:8200"
          {{- if .Values.vault.config.tls.enabled }}
          tls_cert_file: /vault/tls/tls.crt
          tls_key_file: /vault/tls/tls.key
          {{- else }}
          tls_disable: true
          {{- end }}
          telemetry:
            unauthenticated_metrics_access: {{ .Values.vault.config.telemetry.unauthenticated }}
          cluster_address: "0.0.0.0:8201"

    storage:
      {{- if .Values.vault.storage.raft.enabled }}
      raft:
        path: /vault/data
        {{- if gt (.Values.vault.size | int) 1 }}
        retry_join:
          {{- range $i := until (.Values.vault.size | int) }}
          - leader_api_addr: http://{{ $.Values.vault.name }}-{{ $i }}.{{ $.Release.Namespace }}.svc.cluster.local:8200
          {{- end }}
        {{- end }}
      {{- else if .Values.vault.storage.file }}
      file:
        path: /vault/file
      {{- end }}

    service_registration:
      kubernetes:
        namespace: {{ .Release.Namespace }}

    telemetry:
      prometheus_retention_time: {{ .Values.vault.config.telemetry.retention }}
      disable_hostname: {{ .Values.vault.config.telemetry.disableHostname }}

  # External configuration (policies, auth, secrets) - GitOps!
  externalConfig:
    {{- if .Values.vault.externalConfig.policies }}
    policies:
      {{- toYaml .Values.vault.externalConfig.policies | nindent 6 }}
    {{- end }}

    {{- if .Values.vault.externalConfig.auth }}
    auth:
      {{- toYaml .Values.vault.externalConfig.auth | nindent 6 }}
    {{- end }}

    {{- if .Values.vault.externalConfig.secrets }}
    secrets:
      {{- toYaml .Values.vault.externalConfig.secrets | nindent 6 }}
    {{- end }}

    {{- if .Values.vault.externalConfig.startupSecrets }}
    startupSecrets:
      {{- toYaml .Values.vault.externalConfig.startupSecrets | nindent 6 }}
    {{- end }}

  # Resource limits
  {{- if .Values.vault.resources }}
  resources:
    {{- toYaml .Values.vault.resources | nindent 4 }}
  {{- end }}

  # Security context
  {{- if .Values.vault.securityContext }}
  securityContext:
    {{- toYaml .Values.vault.securityContext | nindent 4 }}
  {{- end }}

  # Environment variables for Vault container
  vaultEnvsConfig:
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    {{- if not .Values.vault.config.tls.enabled }}
    - name: VAULT_API_ADDR
      value: "http://$(POD_NAME).{{ .Release.Namespace }}.svc.cluster.local:8200"
    - name: VAULT_CLUSTER_ADDR
      value: "http://$(POD_NAME).{{ .Release.Namespace }}.svc.cluster.local:8201"
    {{- else }}
    - name: VAULT_API_ADDR
      value: "https://$(POD_NAME).{{ .Release.Namespace }}.svc.cluster.local:8200"
    - name: VAULT_CLUSTER_ADDR
      value: "https://$(POD_NAME).{{ .Release.Namespace }}.svc.cluster.local:8201"
    {{- end }}

  # Environment variables for bank-vaults sidecar
  # Override VAULT_ADDR to match Vault's actual TLS configuration (not ingress TLS)
  sidecarEnvsConfig:
    {{- if not .Values.vault.config.tls.enabled }}
    - name: VAULT_ADDR
      value: "http://127.0.0.1:8200"
    {{- else }}
    - name: VAULT_ADDR
      value: "https://127.0.0.1:8200"
    {{- end }}

  # Service account
  serviceAccount: {{ .Values.vault.serviceAccount }}

  # Vault Configurer Pod - override environment to use correct protocol
  vaultConfigurerPodSpec:
    containers:
      - name: vault-configurer
        env:
          {{- if not .Values.vault.config.tls.enabled }}
          - name: VAULT_ADDR
            value: "http://vault.{{ .Release.Namespace }}:8200"
          {{- else }}
          - name: VAULT_ADDR
            value: "https://vault.{{ .Release.Namespace }}:8200"
          {{- end }}

  # Ingress managed by operator is disabled - we create our own to avoid annotation conflicts
  # See vault-ingress.yaml for the actual ingress configuration

  # Service monitor for Prometheus
  {{- if .Values.vault.serviceMonitor.enabled }}
  serviceMonitorEnabled: true
  {{- end }}

  # Statsd for metrics
  {{- if .Values.vault.statsd.enabled }}
  statsdDisabled: false
  statsdImage: {{ .Values.vault.statsd.image }}
  {{- end }}
{{- end }}
