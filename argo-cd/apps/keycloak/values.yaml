keycloak:
  enabled: true
  replicaCount: 1
  keycloak:
    existingSecret: "keycloak-admin"
    secretKeys:
      adminPasswordKey: "password"
    hostnameAdmin: ""
    hostname: ""
    production: true
    proxyHeaders: xforwarded
  cache:
    stack: "ispn"
  database:
    host: ""
    port: ""
    name: ""
    username: ""
    password: ""
  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-http-prod
    hosts:
    - host: ""
      paths:
      - path: /
        pathType: Prefix
    tls:
    - secretName: ""
      hosts:
      - ""
  postgres:
    enabled: false
  mariadb:
    enabled: false
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1000m"
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
              - keycloak
          topologyKey: kubernetes.io/hostname
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
  persistence:
    enabled: true
  extraEnv:
  - name: KC_LOG_LEVEL
    value: INFO

cnpg:
  fullnameOverride: keycloak-pg-cluster
  imageName: ghcr.io/cloudnative-pg/postgresql:17.6
  mode: primary
  dbName: keycloak
  credentials:
    username: keycloak
    password: ""
    postgresPassword: ""
  instances: 3
  enableSuperuserAccess: false
  pvcSize:
    data: 7Gi
    wal: 3Gi
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  affinity:
    topologyKey: kubernetes.io/hostname
  backup:
    enabled: true
    legacyMode: false
    endpointURL: ""
    destinationPath: "s3://<bucket-name>/<bucket-prefix>"
    cron: 0 0 0 * * *
    retentionPolicy: 30d
    compression: gzip
    s3Credentials:
      create: true
      secretName: keycloak-pg-cluster-backup
      accessKeyId:
        key: accessKeyId
        value: ""
      secretAccessKey:
        key: secretAccessKey
        value: ""
      region:
        key: region
        value: ""

keycloakConfigCli:
  enabled: true
  fullnameOverride: keycloak-config-cli
  backoffLimit: 3
  image:
    tag: "latest-26"
  env:
    KEYCLOAK_URL: "http://keycloak:8080"
    KEYCLOAK_USER: "admin"
    IMPORT_FILES_LOCATIONS: "/config/*.json"
    IMPORT_FORCE: "false"
    IMPORT_VAR_SUBSTITUTION_ENABLED: "true"
    IMPORT_VAR_SUBSTITUTION_UNDEFINED_IS_ERROR: "true"
    LOGGING_LEVEL_ROOT: "INFO"
  existingSecret: "keycloak-admin"
  existingSecretKey: "password"
  extraEnv:
  - name: ROOT_DOMAIN
    valueFrom:
      secretKeyRef:
        name: keycloak-config
        key: ROOT_DOMAIN
  - name: KEYCLOAK_DOMAIN
    valueFrom:
      secretKeyRef:
        name: keycloak-config
        key: KEYCLOAK_DOMAIN
  - name: KEYCLOAK_REALM
    valueFrom:
      secretKeyRef:
        name: keycloak-config
        key: KEYCLOAK_REALM
  - name: GITEA_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: keycloak-clients-gitea
        key: CLIENT_SECRET
  - name: GRAFANA_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: keycloak-clients-grafana
        key: CLIENT_SECRET
  - name: ARGOCD_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: keycloak-clients-argocd
        key: CLIENT_SECRET
  - name: MINIO_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: keycloak-clients-minio
        key: CLIENT_SECRET
  # - name: ARGOWORKFLOWS_CLIENT_SECRET
  #   valueFrom:
  #     secretKeyRef:
  #       name: keycloak-clients-argoworkflows
  #       key: CLIENT_SECRET
  # - name: CODER_CLIENT_SECRET
  #   valueFrom:
  #     secretKeyRef:
  #       name: keycloak-clients-coder
  #       key: CLIENT_SECRET
  # - name: OUTLINE_CLIENT_SECRET
  #   valueFrom:
  #     secretKeyRef:
  #       name: keycloak-clients-outline
  #       key: CLIENT_SECRET
  # - name: MLFLOW_CLIENT_SECRET
  #   valueFrom:
  #     secretKeyRef:
  #       name: keycloak-clients-mlflow
  #       key: CLIENT_SECRET
  # - name: SONARQUBE_CLIENT_SECRET
  #   valueFrom:
  #     secretKeyRef:
  #       name: keycloak-clients-sonarqube
  #       key: CLIENT_SECRET
  # - name: HARBOR_CLIENT_SECRET
  #   valueFrom:
  #     secretKeyRef:
  #       name: keycloak-clients-harbor
  #       key: CLIENT_SECRET
  # - name: VAULTWARDEN_CLIENT_SECRET
  #   valueFrom:
  #     secretKeyRef:
  #       name: keycloak-clients-vaultwarden
  #       key: CLIENT_SECRET
  config:
    homelab:
      inline:
        realm: "$(env:KEYCLOAK_REALM)"
        enabled: true
        displayName: "Homelab"
        displayNameHtml: "<b>Homelab</b> Identity"
        registrationAllowed: false
        registrationEmailAsUsername: true
        editUsernameAllowed: false
        resetPasswordAllowed: true
        rememberMe: true
        verifyEmail: false
        loginWithEmailAllowed: true
        duplicateEmailsAllowed: false
        ssoSessionIdleTimeout: 1800
        ssoSessionMaxLifespan: 36000
        offlineSessionIdleTimeout: 2592000
        accessTokenLifespan: 300
        bruteForceProtected: true
        permanentLockout: false
        maxFailureWaitSeconds: 900
        minimumQuickLoginWaitSeconds: 60
        waitIncrementSeconds: 60
        quickLoginCheckMilliSeconds: 1000
        maxDeltaTimeSeconds: 43200
        failureFactor: 5
        roles:
          client:
            grafana:
            - name: "grafanaadmin"
              description: "Grafana administrator role"
            - name: "admin"
              description: "Grafana admin role"
            - name: "editor"
              description: "Grafana editor role"
            minio:
            - name: "consoleAdmin"
              description: "MinIO console administrator"
            - name: "diagnostics"
              description: "MinIO diagnostics role"
            - name: "readonly"
              description: "MinIO read-only access"
            - name: "readwrite"
              description: "MinIO read-write access"
            - name: "writeonly"
              description: "MinIO write-only access"
        groups:
        - name: "admin"
          path: "/admin"
          clientRoles:
            grafana:
            - "grafanaadmin"
            minio:
            - "consoleAdmin"
            - "diagnostics"
            - "readonly"
            - "readwrite"
            - "writeonly"
        clients:
        - clientId: "gitea"
          name: "Gitea"
          description: "Git hosting platform"
          enabled: true
          clientAuthenticatorType: "client-secret"
          secret: "$(env:GITEA_CLIENT_SECRET)"
          redirectUris:
          - "https://git.$(env:ROOT_DOMAIN)/*"
          - "https://git.$(env:ROOT_DOMAIN)/user/oauth2/keycloak/callback"
          webOrigins:
          - "https://git.$(env:ROOT_DOMAIN)"
          protocol: "openid-connect"
          publicClient: false
          standardFlowEnabled: true
          implicitFlowEnabled: false
          directAccessGrantsEnabled: true
          serviceAccountsEnabled: false
          defaultClientScopes:
          - "web-origins"
          - "acr"
          - "profile"
          - "roles"
          - "email"
          - "groups"
          optionalClientScopes:
          - "address"
          - "phone"
          - "offline_access"
          - "microprofile-jwt"
        - clientId: "grafana"
          name: "Grafana"
          description: "Monitoring dashboards"
          enabled: true
          clientAuthenticatorType: "client-secret"
          secret: "$(env:GRAFANA_CLIENT_SECRET)"
          redirectUris:
          - "https://monitoring.$(env:ROOT_DOMAIN)/*"
          - "https://monitoring.$(env:ROOT_DOMAIN)/login/generic_oauth"
          webOrigins:
          - "https://monitoring.$(env:ROOT_DOMAIN)"
          protocol: "openid-connect"
          publicClient: false
          standardFlowEnabled: true
          implicitFlowEnabled: false
          directAccessGrantsEnabled: true
          serviceAccountsEnabled: false
          defaultClientScopes:
          - "web-origins"
          - "acr"
          - "profile"
          - "roles"
          - "email"
          - "groups"
          optionalClientScopes:
          - "address"
          - "phone"
          - "offline_access"
          - "microprofile-jwt"
          protocolMappers:
          - name: "Client Role Mapper"
            protocol: "openid-connect"
            protocolMapper: "oidc-usermodel-client-role-mapper"
            consentRequired: false
            config:
              "user.attribute": "role"
              "access.token.claim": "true"
              "claim.name": "roles"
              "jsonType.label": "String"
              "multivalued": "true"
              "userinfo.token.claim": "true"
              "id.token.claim": "true"
              "client_id": "grafana"
        - clientId: "argo-cd"
          name: "Argo CD"
          description: "GitOps continuous delivery"
          enabled: true
          clientAuthenticatorType: "client-secret"
          secret: "$(env:ARGOCD_CLIENT_SECRET)"
          redirectUris:
          - "https://gitops.$(env:ROOT_DOMAIN)/*"
          - "https://gitops.$(env:ROOT_DOMAIN)/auth/callback"
          webOrigins:
          - "https://gitops.$(env:ROOT_DOMAIN)"
          protocol: "openid-connect"
          publicClient: false
          standardFlowEnabled: true
          implicitFlowEnabled: false
          directAccessGrantsEnabled: true
          serviceAccountsEnabled: false
          defaultClientScopes:
          - "web-origins"
          - "acr"
          - "profile"
          - "roles"
          - "email"
          - "groups"
          optionalClientScopes:
          - "address"
          - "phone"
          - "offline_access"
          - "microprofile-jwt"
        - clientId: "minio"
          name: "MinIO"
          description: "Object storage"
          enabled: true
          clientAuthenticatorType: "client-secret"
          secret: "$(env:MINIO_CLIENT_SECRET)"
          redirectUris:
          - "https://minio.$(env:ROOT_DOMAIN)/*"
          - "https://minio.$(env:ROOT_DOMAIN)/oauth_callback"
          webOrigins:
          - "https://minio.$(env:ROOT_DOMAIN)"
          protocol: "openid-connect"
          publicClient: false
          standardFlowEnabled: true
          implicitFlowEnabled: false
          directAccessGrantsEnabled: true
          serviceAccountsEnabled: false
          attributes:
            "use.jwks.url": "true"
            "jwks.url": "https://sso.$(env:ROOT_DOMAIN)/realms/$(env:KEYCLOAK_REALM)/protocol/openid-connect/certs"
          protocolMappers:
          - name: "minio-policy-mapper"
            protocol: "openid-connect"
            protocolMapper: "oidc-usermodel-client-role-mapper"
            consentRequired: false
            config:
              "id.token.claim": "true"
              "access.token.claim": "true"
              "claim.name": "minio-policy"
              "userinfo.token.claim": "true"
              "jsonType.label": "String"
              "aggregate.attrs": "true"
              "client_id": "minio"
              "multivalued": "true"
          defaultClientScopes:
          - "web-origins"
          - "acr"
          - "profile"
          - "roles"
          - "email"
          - "groups"
          optionalClientScopes:
          - "address"
          - "phone"
          - "offline_access"
          - "microprofile-jwt"
        # - clientId: "argo-workflows"
        #   name: "Argo Workflows"
        #   description: "Workflow engine"
        #   enabled: true
        #   clientAuthenticatorType: "client-secret"
        #   secret: "$(env:ARGOWORKFLOWS_CLIENT_SECRET)"
        #   redirectUris:
        #   - "https://worflows.$(env:ROOT_DOMAIN)/*"
        #   - "https://worflows.$(env:ROOT_DOMAIN)/oauth2/callback"
        #   webOrigins:
        #   - "https://worflows.$(env:ROOT_DOMAIN)"
        #   protocol: "openid-connect"
        #   publicClient: false
        #   standardFlowEnabled: true
        #   implicitFlowEnabled: false
        #   directAccessGrantsEnabled: false
        #   serviceAccountsEnabled: false
        #   attributes:
        #     "pkce.code.challenge.method": "S256"
        #   defaultClientScopes:
        #   - "web-origins"
        #   - "acr"
        #   - "profile"
        #   - "roles"
        #   - "email"
        #   - "groups"
        #   optionalClientScopes:
        #   - "address"
        #   - "phone"
        #   - "offline_access"
        #   - "microprofile-jwt"
        # - clientId: "coder"
        #   name: "Coder"
        #   description: "Development workspaces"
        #   enabled: true
        #   clientAuthenticatorType: "client-secret"
        #   secret: "$(env:CODER_CLIENT_SECRET)"
        #   redirectUris:
        #   - "https://coder.$(env:ROOT_DOMAIN)/*"
        #   - "https://coder.$(env:ROOT_DOMAIN)/oauth2/callback"
        #   webOrigins:
        #   - "https://coder.$(env:ROOT_DOMAIN)"
        #   protocol: "openid-connect"
        #   publicClient: false
        #   standardFlowEnabled: true
        #   implicitFlowEnabled: false
        #   directAccessGrantsEnabled: false
        #   serviceAccountsEnabled: false
        #   attributes:
        #     "pkce.code.challenge.method": "S256"
        #   defaultClientScopes:
        #   - "web-origins"
        #   - "acr"
        #   - "profile"
        #   - "roles"
        #   - "email"
        #   - "groups"
        #   optionalClientScopes:
        #   - "address"
        #   - "phone"
        #   - "offline_access"
        #   - "microprofile-jwt"
        # - clientId: "outline"
        #   name: "Outline"
        #   description: "Team wiki"
        #   enabled: true
        #   clientAuthenticatorType: "client-secret"
        #   secret: "$(env:OUTLINE_CLIENT_SECRET)"
        #   redirectUris:
        #   - "https://wiki.$(env:ROOT_DOMAIN)/*"
        #   - "https://wiki.$(env:ROOT_DOMAIN)/auth/oidc.callback"
        #   webOrigins:
        #   - "https://wiki.$(env:ROOT_DOMAIN)"
        #   protocol: "openid-connect"
        #   publicClient: false
        #   standardFlowEnabled: true
        #   implicitFlowEnabled: false
        #   directAccessGrantsEnabled: false
        #   serviceAccountsEnabled: false
        #   attributes:
        #     "pkce.code.challenge.method": "S256"
        #   defaultClientScopes:
        #   - "web-origins"
        #   - "acr"
        #   - "profile"
        #   - "roles"
        #   - "email"
        #   - "groups"
        #   optionalClientScopes:
        #   - "address"
        #   - "phone"
        #   - "offline_access"
        #   - "microprofile-jwt"
        # - clientId: "mlflow"
        #   name: "MLflow"
        #   description: "ML experiment tracking"
        #   enabled: true
        #   clientAuthenticatorType: "client-secret"
        #   secret: "$(env:MLFLOW_CLIENT_SECRET)"
        #   redirectUris:
        #   - "https://mlflow.$(env:ROOT_DOMAIN)/*"
        #   - "https://mlflow.$(env:ROOT_DOMAIN)/oauth2/callback"
        #   webOrigins:
        #   - "https://mlflow.$(env:ROOT_DOMAIN)"
        #   protocol: "openid-connect"
        #   publicClient: false
        #   standardFlowEnabled: true
        #   implicitFlowEnabled: false
        #   directAccessGrantsEnabled: false
        #   serviceAccountsEnabled: false
        #   attributes:
        #     "pkce.code.challenge.method": "S256"
        #   defaultClientScopes:
        #   - "web-origins"
        #   - "acr"
        #   - "profile"
        #   - "roles"
        #   - "email"
        #   - "groups"
        #   optionalClientScopes:
        #   - "address"
        #   - "phone"
        #   - "offline_access"
        #   - "microprofile-jwt"
        # - clientId: "sonarqube"
        #   name: "SonarQube"
        #   description: "Code quality analysis"
        #   enabled: true
        #   clientAuthenticatorType: "client-secret"
        #   secret: "$(env:SONARQUBE_CLIENT_SECRET)"
        #   redirectUris:
        #   - "https://sonarqube.$(env:ROOT_DOMAIN)/*"
        #   - "https://sonarqube.$(env:ROOT_DOMAIN)/oauth2/callback/oidc"
        #   webOrigins:
        #   - "https://sonarqube.$(env:ROOT_DOMAIN)"
        #   protocol: "openid-connect"
        #   publicClient: false
        #   standardFlowEnabled: true
        #   implicitFlowEnabled: false
        #   directAccessGrantsEnabled: false
        #   serviceAccountsEnabled: false
        #   attributes:
        #     "pkce.code.challenge.method": "S256"
        #   defaultClientScopes:
        #   - "web-origins"
        #   - "acr"
        #   - "profile"
        #   - "roles"
        #   - "email"
        #   - "groups"
        #   optionalClientScopes:
        #   - "address"
        #   - "phone"
        #   - "offline_access"
        #   - "microprofile-jwt"
        # - clientId: "harbor"
        #   name: "Harbor"
        #   description: "Container registry"
        #   enabled: true
        #   clientAuthenticatorType: "client-secret"
        #   secret: "$(env:HARBOR_CLIENT_SECRET)"
        #   redirectUris:
        #   - "https://registry.$(env:ROOT_DOMAIN)/*"
        #   - "https://registry.$(env:ROOT_DOMAIN)/c/oidc/callback"
        #   webOrigins:
        #   - "https://registry.$(env:ROOT_DOMAIN)"
        #   protocol: "openid-connect"
        #   publicClient: false
        #   standardFlowEnabled: true
        #   implicitFlowEnabled: false
        #   directAccessGrantsEnabled: false
        #   serviceAccountsEnabled: false
        #   attributes:
        #     "pkce.code.challenge.method": "S256"
        #   defaultClientScopes:
        #   - "web-origins"
        #   - "acr"
        #   - "profile"
        #   - "roles"
        #   - "email"
        #   - "groups"
        #   optionalClientScopes:
        #   - "address"
        #   - "phone"
        #   - "offline_access"
        #   - "microprofile-jwt"
        # - clientId: "vaultwarden"
        #   name: "Vaultwarden"
        #   description: "Password manager"
        #   enabled: true
        #   clientAuthenticatorType: "client-secret"
        #   secret: "$(env:VAULTWARDEN_CLIENT_SECRET)"
        #   redirectUris:
        #   - "https://vaultwarden.$(env:ROOT_DOMAIN)/*"
        #   - "https://vaultwarden.$(env:ROOT_DOMAIN)/identity/connect/oidc-signin"
        #   webOrigins:
        #   - "https://vaultwarden.$(env:ROOT_DOMAIN)"
        #   protocol: "openid-connect"
        #   publicClient: false
        #   standardFlowEnabled: true
        #   implicitFlowEnabled: false
        #   directAccessGrantsEnabled: false
        #   serviceAccountsEnabled: false
        #   attributes:
        #     "pkce.code.challenge.method": "S256"
        #   defaultClientScopes:
        #   - "web-origins"
        #   - "acr"
        #   - "profile"
        #   - "roles"
        #   - "email"
        #   - "groups"
        #   optionalClientScopes:
        #   - "address"
        #   - "phone"
        #   - "offline_access"
        #   - "microprofile-jwt"
        # clientScopes:
        # - name: "groups"
        #   description: "User groups"
        #   protocol: "openid-connect"
        #   attributes:
        #     "include.in.token.scope": "true"
        #     "display.on.consent.screen": "true"
        #   protocolMappers:
        #   - name: "groups"
        #     protocol: "openid-connect"
        #     protocolMapper: "oidc-group-membership-mapper"
        #     consentRequired: false
        #     config:
        #       "full.path": "false"
        #       "id.token.claim": "true"
        #       "access.token.claim": "true"
        #       "claim.name": "groups"
        #       "userinfo.token.claim": "true"
        # roles:
        #   realm:
        #   - name: "admin"
        #     description: "Administrator role"
        #   - name: "user"
        #     description: "Standard user role"
        # users: []
        # groups: []
