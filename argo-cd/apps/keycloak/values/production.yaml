keycloak:
  enabled: true
  replicaCount: 1
  keycloak:
    existingSecret: "keycloak-admin"
    secretKeys:
      adminPasswordKey: "password"
    hostnameAdmin: https://<path:secret/data/platforms/production/apps/keycloak#domain>
    hostname: https://<path:secret/data/platforms/production/apps/keycloak#domain>
    production: true
    proxyHeaders: xforwarded
  cache:
    stack: "ispn"
  database:
    host: <path:secret/data/platforms/production/apps/keycloak#postgres | jsonPath {.host}>
    port: <path:secret/data/platforms/production/apps/keycloak#postgres | jsonPath {.port}>
    name: <path:secret/data/platforms/production/apps/keycloak#postgres | jsonPath {.database}>
    username: <path:secret/data/platforms/production/apps/keycloak#postgres | jsonPath {.app.username}>
    password: <path:secret/data/platforms/production/apps/keycloak#postgres | jsonPath {.app.password}>
  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-http-prod
    hosts:
    - host: <path:secret/data/platforms/production/apps/keycloak#domain>
      paths:
      - path: /
        pathType: Prefix
    tls:
    - secretName: <path:secret/data/platforms/production/apps/keycloak#domain>-tls
      hosts:
      - <path:secret/data/platforms/production/apps/keycloak#domain>
  postgres:
    enabled: false
  mariadb:
    enabled: false
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1000m"
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
              - keycloak
          topologyKey: kubernetes.io/hostname
  persistence:
    enabled: true
  extraEnv:
    KC_LOG_LEVEL: INFO

cnpg:
  fullnameOverride: keycloak-pg-cluster
  imageName: ghcr.io/cloudnative-pg/postgresql:15.4
  dbName: keycloak
  credentials:
    username: keycloak
    password: <path:secret/data/platforms/production/apps/keycloak#postgres | jsonPath {.app.password}>
    postgresPassword: <path:secret/data/platforms/production/apps/keycloak#postgres | jsonPath {.admin.password}>
  mode: primary
  instances: 3
  enableSuperuserAccess: false
  pvcSize:
    data: 7Gi
    wal: 3Gi
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  backup:
    enabled: false
    endpointURL: <path:secret/data/platforms/production/apps/keycloak#postgres | jsonPath {.s3.endpoint}>
    destinationPath: s3://<path:secret/data/platforms/production/apps/keycloak#postgres | jsonPath {.s3.bucketName}>/<path:secret/data/platforms/production/apps/keycloak#postgres | jsonPath {.s3.bucketPrefix}>
    cron: 0 0 0 * * *
    retentionPolicy: 30d
    compression: gzip
    s3Credentials:
      create: true
      secretName: keycloak-pg-cluster-backup
      accessKeyId:
        key: accessKeyId
        value: <path:secret/data/platforms/production/apps/keycloak#postgres | jsonPath {.s3.accessKey}>
      secretAccessKey:
        key: secretAccessKey
        value: <path:secret/data/platforms/production/apps/keycloak#postgres | jsonPath {.s3.secretKey}>
      region:
        key: region
        value: <path:secret/data/platforms/production/apps/keycloak#postgres | jsonPath {.s3.region}>
